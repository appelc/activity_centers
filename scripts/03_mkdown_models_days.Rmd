---
title: "Activity center models - days with detections"
author: "Cara"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(data.table)
library(broom)
library(tidyverse)
library(effects)
library(ggplot2)
library(plyr)
library(kableExtra)
library(nlme)
```

------------------------------------------------------------------------

### Preliminary models for analyzing spotted owl activity center ("big grid") data from 2021

------------------------------------------------------------------------

#### Load data:

##### 145 rows = 145 ARU stations from 4 different study areas

```{r echo=FALSE}
  #import nDays summary
  daysSTOC <- fread('../output/09_ac_21_nights_with_det.csv')

  #import station summary
  acData <- fread('../output/05_ac_2021_merged.csv')
  
  #merge some columns and order level
  daysMerge <- merge(daysSTOC[,-c('V1')], acData[,c('SITESTN','reproState','Distance','dist_intended')])
  daysMerge$reproState <- factor(daysMerge$reproState, levels = c('pair','nest','fledged'))
  
  # #add 'proportion' column
  # daysMerge$propAny <- daysMerge$propAny <- daysMerge$nights_STOC_ANY / daysMerge$duration
    ## if doing it this way, use the following call:
    ## glm(prop ~ reproState * Distance, data = daysMerge, family = binomial, weights = duration)
  
  daysMerge[,-c('dist_intended')]
    
```

------------------------------------------------------------------------

### -- Models using the proportion of survey nights with any spotted owl detection as the response variable

### 0. prelim model exploration

Try binomial with proportion data

```{r}

mod1 <- glm(cbind(nights_STOC_ANY, duration-nights_STOC_ANY) ~ reproState,
            data = daysMerge, family = binomial(link = 'log'))
summary(mod1)

```

We have overdispersion (residual deviance \>\>\> df)

Try quasibinomial:

```{r}

mod2 <- glm(cbind(nights_STOC_ANY, duration-nights_STOC_ANY) ~ reproState,
            data = daysMerge, family = quasibinomial(link = 'log'))
summary(mod2)
```

Still overdispersed. (Look at the Disperson parameter, now right? 35 is high)

Try GLMM with random effect for ARU station:

```{r}

#null model
mod3.null <- glmer(cbind(nights_STOC_ANY, duration - nights_STOC_ANY) 
                   ~ 1 + (1|SITESTN), family = binomial, data = daysMerge)
summary(mod3.null)

#reproductive state
mod3.repro <- glmer(cbind(nights_STOC_ANY, duration - nights_STOC_ANY) 
                    ~ reproState + (1|SITESTN), 
                    family = binomial, data = daysMerge)
summary(mod3.repro)

#distance
mod3.dist <- glmer(cbind(nights_STOC_ANY, duration - nights_STOC_ANY) 
                   ~ Distance + (1|SITESTN),
                    family = binomial, data = daysMerge)

#scale distance variable
daysMerge$distScaled <- scale(daysMerge$Distance)
  hist(daysMerge$Distance)  
  hist(daysMerge$distScaled)
  
#distance (scaled)  
mod3.dist.scaled <- glmer(cbind(nights_STOC_ANY, duration - nights_STOC_ANY) 
                          ~ distScaled + (1|SITESTN),
                          family = binomial, data = daysMerge)

```

#### 1. effect of reproductive state

```{r}

  any.prop.repro <- glm(cbind(nights_STOC_ANY, duration - nights_STOC_ANY) ~ reproState,
                        data = daysMerge, family = binomial)
  
    round(summary(any.prop.repro)$coefficients, 4)

  #back-transformed coefficients (is this the probability of detection on a single night?)
  allEffects(any.prop.repro)

```

#### reorder levels so intercept is 'fledged'

```{r}

  daysMerge2 <- daysMerge
  daysMerge2$reproState <- factor(daysMerge2$reproState, levels = c('fledged','nest','pair'))

  any.prop.repro2 <- glm(cbind(nights_STOC_ANY, duration - nights_STOC_ANY) ~ reproState,
                        data = daysMerge2, family = binomial)
  
    round(summary(any.prop.repro2)$coefficients, 4)

```

```{r, echo=FALSE}

## plot effects above

  #save effects as dataframe
  df.any.prop.repro <- allEffects(any.prop.repro)
  df.any.prop.repro <- data.frame(df.any.prop.repro$reproState)
  df.any.prop.repro$reproState <- factor(df.any.prop.repro$reproState, levels = c('pair','nest','fledged'))
  
  #and plot
  plot.any.prop.repro <- ggplot(df.any.prop.repro, aes(x = reproState, y = fit)) + 
    geom_point(size = 3) +
    geom_errorbar(aes(ymin = lower, ymax = upper)) +
    # ylim(c(0,0.5)) +
    ylab('Probability)') +
    # ggtitle('Spotted owl detections by reproductive state') +
    theme(panel.background = element_rect(fill = 'transparent'),
          panel.grid = element_line(color = 'gray90'),
          axis.line = element_line(),
          axis.title = element_text(size = 18),
          axis.title.x = element_blank(),
          strip.text = element_text(size = 16),
          axis.text = element_text(size = 16),
          plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 16),
          legend.title = element_blank(),
          legend.position = 'none',
          legend.background = element_rect(fill='transparent'))
  plot.any.prop.repro

# plot(allEffects(any.prop.repro))  #for comparison

```

### 

### 

#### 2. effect of distance from center

```{r}

  any.prop.dist <- glm(cbind(nights_STOC_ANY, duration - nights_STOC_ANY) ~ Distance,
                       data = daysMerge, family = binomial)
  
  round(summary(any.prop.dist)$coefficients, 4)

  #back-transformed coefficients
  allEffects(any.prop.dist) 
  
```

```{r, echo=FALSE}

## plot effects
propdist <- ggplot(daysMerge, aes(x = Distance/1000, y = nights_STOC_4N/duration, 
                                  nights = nights_STOC_4N, total = duration)) +
  geom_point(color = 'gray70') +
  geom_smooth(method = 'glm', method.args = list(family = 'binomial'),
              formula = cbind(nights, total - nights) ~ x) +
  # theme_bw() +
  geom_rug(sides = 'b', lwd = 1) +
  xlab('Distance from center (km)') + ylab('Probability') +
  theme(
    panel.background = element_rect(fill = 'transparent'),
          panel.grid = element_line(color = 'gray90'),
          axis.line = element_line(),
          axis.title = element_text(size = 18),
          # axis.title.x = element_blank(),
          strip.text = element_text(size = 16),
          axis.text = element_text(size = 16),
          plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 16),
          legend.title = element_blank(),
          legend.position = 'none',
          legend.background = element_rect(fill='transparent'))
propdist

# plot(allEffects(any.prop.dist))

###

```

### 

#### 3. interaction of reproState \* distance

```{r}

  any.prop.repro.dist <- glm(cbind(nights_STOC_ANY, duration - nights_STOC_ANY) ~ reproState * Distance,
                             data = daysMerge, family = binomial)

    round(summary(any.prop.repro.dist)$coefficients, 4)

  #back-transformed coefficients 
  allEffects(any.prop.repro.dist)    
  
```

#### reorder levels so intercept is 'fledged'

```{r}

  any.prop.repro.dist2 <- glm(cbind(nights_STOC_ANY, duration - nights_STOC_ANY) ~ reproState * Distance,
                               data = daysMerge2, family = binomial)

    round(summary(any.prop.repro.dist2)$coefficients, 4)

```

```{r, echo=FALSE}

## plot

  plot.any.prop.repro.dist2 <- ggplot(daysMerge, aes(x = Distance/1000, y = nights_STOC_4N/duration, 
                                                     nights = nights_STOC_4N, total = duration)) +
  geom_point(color = 'gray70') +
  geom_smooth(method = 'glm', method.args = list(family = 'binomial'),
              formula = cbind(nights, total - nights) ~ x) + 
  facet_grid(~reproState) +
      ylim(c(0,0.5)) +
    ylab('Probability') +
    xlab('Distance from center (km)') +
    # ggtitle('Spotted owl detections by reproductive state') +
    theme(panel.background = element_rect(fill = 'transparent'),
          panel.grid = element_line(color = 'gray90'),
          axis.line = element_line(),
          axis.title = element_text(size = 18),
          # axis.title.x = element_blank(),
          strip.text = element_text(size = 16),
          axis.text = element_text(size = 16),
          plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 16),
          legend.title = element_blank(),
          legend.position = 'none',
          legend.background = element_rect(fill='transparent'))
  plot.any.prop.repro.dist2


```

### 

#### -- compare models using AIC

```{r, echo=FALSE}

## Compare models
  mods.aic.any <- data.frame('model' = c('null','reproState','distance','reproState*dist'),
                         'AIC' = c(AIC(glm(cbind(nights_STOC_ANY,duration) ~ 1, 
                                           data = daysMerge, family = binomial)),
                                   AIC(any.prop.repro), 
                                   AIC(any.prop.dist),
                                   AIC(any.prop.repro.dist)))
  mods.aic.any <- mods.aic.any[order(mods.aic.any$AIC),]  
  mods.aic.any$delta_AIC <- mods.aic.any$AIC - mods.aic.any$AIC[1]
  
                         
  mods.aic.any %>%
    kbl(digits = 3) %>%
    kable_styling(bootstrap_options = 'striped', font_size = 14, full_width = FALSE, position = 'left')
  

```

### --------------------------------------------------------------------------------

### -- Models using the proportion of survey nights with detections of females/males as the response variable

### 

#### 1. effect of reproductive state -- separately for F/M

```{r}

  #females
  fem.prop.repro <- glm(cbind(nights_STOC_FEMALE, duration - nights_STOC_FEMALE) ~ reproState,
                        data = daysMerge, family = binomial)
  
    round(summary(fem.prop.repro)$coefficients, 4)
    
    #reorder levels
    fem.prop.repro2 <- glm(cbind(nights_STOC_FEMALE, duration - nights_STOC_FEMALE) ~ reproState,
                          data = daysMerge2, family = binomial)
  
    round(summary(fem.prop.repro2)$coefficients, 4)
  

  
  #males
  male.prop.repro <- glm(cbind(nights_STOC_MALE, duration - nights_STOC_MALE) ~ reproState,
                        data = daysMerge, family = binomial)
  
    round(summary(male.prop.repro)$coefficients, 4)
    
    #reorder levels
    male.prop.repro2 <- glm(cbind(nights_STOC_MALE, duration - nights_STOC_MALE) ~ reproState,
                            data = daysMerge2, family = binomial)
  
    round(summary(male.prop.repro2)$coefficients, 4)
    
    #back-transformed coefficients
    allEffects(fem.prop.repro) 
    allEffects(male.prop.repro) 
  
```

```{r, echo=FALSE}

## plot effects above

#save effects as dataframe
  df.f.repro.prop <- allEffects(fem.prop.repro)
  df.f.repro.prop <- data.frame(df.f.repro.prop$reproState); df.f.repro.prop$sex <- 'female'

  df.m.repro.prop <- allEffects(male.prop.repro)
  df.m.repro.prop <- data.frame(df.m.repro.prop$reproState); df.m.repro.prop$sex <- 'male'
  
  fm.repro.prop <- rbind(df.f.repro.prop, df.m.repro.prop)
  
  fm.repro.prop$reproState <- factor(fm.repro.prop$reproState,
                                    levels = c('pair','nest','fledged'))
  
  #and plot
  plot.fm.repro.prop <- ggplot(fm.repro.prop, aes(x = reproState, y = fit)) + 
      geom_point(size = 3) +
      geom_errorbar(aes(ymin = lower, ymax = upper)) +
      facet_grid(~sex) +
      # ylim(c(0,1)) +
      ylab('Probability') +
      # scale_color_manual(values = c('tomato1', 'steelblue2', 'seagreen')) +
      # ggtitle('Spotted owl detections by reproductive state') +
      theme(panel.background = element_rect(fill = 'transparent'),
            panel.grid = element_line(color = 'gray90'),
            axis.line = element_line(),
            axis.title = element_text(size = 18),
            axis.title.x = element_blank(),
            strip.text = element_text(size = 16),
            axis.text = element_text(size = 16),
            plot.title = element_text(hjust = 0.5),
            legend.text = element_text(size = 16),
            legend.title = element_blank(),
            legend.position = 'none',
            legend.background = element_rect(fill='transparent'))
    plot.fm.repro.prop

# plot(allEffects(fem.prop.repro))  #for comparison
# plot(allEffects(male.prop.repro))  #for comparison

```

### 

#### 2. effect of distance from center -- separately for F/M

```{r}

  #females
  fem.prop.dist <- glm(cbind(nights_STOC_FEMALE, duration - nights_STOC_FEMALE) ~ Distance,
                       data = daysMerge, family = binomial)

    round(summary(fem.prop.dist)$coefficients, 4)
    
  #males
  male.prop.dist <- glm(cbind(nights_STOC_MALE, duration - nights_STOC_FEMALE) ~ Distance,
                       data = daysMerge, family = binomial)  
  
    round(summary(male.prop.dist)$coefficients, 4)
    
    #effects
    allEffects(fem.prop.dist)
    allEffects(male.prop.dist) 

```

```{r, echo=FALSE}

## plot effects

#create longform dataframe
daysMergeLong <- melt(daysMerge, id.vars = c('SITESTN','duration','reproState','Distance','dist_intended'),
                      value.name = 'n')

#and plot
plot.mf.dist <- ggplot(daysMergeLong, aes(x = Distance/1000, y = n/duration, 
                                          nights = n, total = duration, color = )) +
  geom_point(data = daysMergeLong[daysMergeLong$variable %in% 'nights_STOC_MALE',],
             color = 'cyan4', alpha = 0.3) +
  geom_point(data = daysMergeLong[daysMergeLong$variable %in% 'nights_STOC_FEMALE',],
             color = 'tomato1', alpha = 0.3) +
  geom_smooth(data = daysMergeLong[daysMergeLong$variable %in% 'nights_STOC_FEMALE',],
              method = 'glm', method.args = list(family = 'binomial'),
              formula = cbind(nights, total - nights) ~ x, aes(color = 'Female')) +
  geom_smooth(data = daysMergeLong[daysMergeLong$variable %in% 'nights_STOC_MALE',],
            method = 'glm', method.args = list(family = 'binomial'),
              formula = cbind(nights, total - nights) ~ x, aes(color = 'Male')) +
  # geom_rug(sides = 'b', lwd = 1) +
  geom_rug(data = daysMergeLong[daysMergeLong$variable %in% 'nights_STOC_MALE' &
                                  daysMergeLong$n > 0], color = 'cyan4', sides = "b", outside = TRUE) +
  geom_rug(data = daysMergeLong[daysMergeLong$variable %in% 'nights_STOC_FEMALE' &
                                  daysMergeLong$n > 0], color = 'tomato1', sides = "b") +
  coord_cartesian(clip = "off") +
  xlab('Distance from center (km)') + ylab('Probability') + 
  ylim(c(0,0.5)) +
  theme(
    panel.background = element_rect(fill = 'transparent'),
          panel.grid = element_line(color = 'gray90'),
          axis.line = element_line(),
          axis.title = element_text(size = 18),
          # axis.title.x = element_blank(),
          strip.text = element_text(size = 16),
          axis.text = element_text(size = 16),
          plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 16),
          legend.title = element_blank(),
          # legend.position = 'none',
          legend.background = element_rect(fill='transparent'))

plot.mf.dist

# plot(allEffects(fem.prop.dist))
# plot(allEffects(male.prop.dist))

```

### 

#### 3. interaction of reproState \* distance

```{r}

  #females
  fem.prop.repro.dist <- glm(cbind(nights_STOC_FEMALE, duration - nights_STOC_FEMALE) ~ 
                               reproState * Distance,
                             data = daysMerge, family = binomial)

    round(summary(fem.prop.repro.dist)$coefficients, 4)
    
    #reorder levels
    fem.prop.repro.dist2 <- glm(cbind(nights_STOC_FEMALE, duration- nights_STOC_FEMALE) ~ 
                                  reproState * Distance,
                                data = daysMerge2, family = binomial)
    round(summary(fem.prop.repro.dist2)$coefficients, 4)
      
  #males
  male.prop.repro.dist <- glm(cbind(nights_STOC_MALE, duration - nights_STOC_MALE) ~ 
                                reproState * Distance,
                              data = daysMerge, family = binomial)

    round(summary(male.prop.repro.dist)$coefficients, 4) 
    
    #reorder levels
    male.prop.repro.dist2 <- glm(cbind(nights_STOC_MALE, duration - nights_STOC_MALE) ~ 
                                   reproState * Distance,
                                 data = daysMerge2, family = binomial)

    round(summary(male.prop.repro.dist2)$coefficients, 4) 


  #back-transformed coefficients
  allEffects(fem.prop.repro.dist)
  allEffects(male.prop.repro.dist)
  
```

```{r, echo=FALSE}

## plot 

plot.fm.repro.dist <- ggplot(daysMergeLong, aes(x = Distance/1000, y = n/duration, 
                                                 nights = n, total = duration)) +
    geom_point(data = daysMergeLong[daysMergeLong$variable %in% 'nights_STOC_MALE',],
             color = 'cyan4', alpha = 0.3) +
    geom_point(data = daysMergeLong[daysMergeLong$variable %in% 'nights_STOC_FEMALE',],
               color = 'tomato1', alpha = 0.3) +
    geom_smooth(data = daysMergeLong[daysMergeLong$variable %in% 'nights_STOC_FEMALE',],
                method = 'glm', method.args = list(family = 'binomial'),
                formula = cbind(nights, total - nights) ~ x, aes(color = 'Female')) +
    geom_smooth(data = daysMergeLong[daysMergeLong$variable %in% 'nights_STOC_MALE',],
              method = 'glm', method.args = list(family = 'binomial'),
                formula = cbind(nights, total - nights) ~ x, aes(color = 'Male')) +
    facet_grid(~reproState) +
      ylim(c(0,0.5)) +
      ylab('Probability') +
      xlab('Distance from center (km)') +
      theme(panel.background = element_rect(fill = 'transparent'),
            panel.grid = element_line(color = 'gray90'),
            axis.line = element_line(),
            axis.title = element_text(size = 18),
            # axis.title.x = element_blank(),
            strip.text = element_text(size = 16),
            axis.text = element_text(size = 16),
            # plot.title = element_text(hjust = 0.5),
            legend.text = element_text(size = 16),
            legend.title = element_blank(),
            # legend.position = 'none',
            legend.background = element_rect(fill='transparent'))
plot.fm.repro.dist
    
```

### 

#### -- compare models (females)

```{r, echo=FALSE}

## Compare models

  #female
  mods.aic.f <- data.frame('model' = c('null','reproState','distance','reproState*dist'),
                           'AIC' = c(AIC(glm(cbind(nights_STOC_FEMALE, duration) ~ 1, 
                                             data = daysMerge, family = binomial)),
                                     AIC(fem.prop.repro), 
                                     AIC(fem.prop.dist),
                                     AIC(fem.prop.repro.dist)))
  mods.aic.f <- mods.aic.f[order(mods.aic.f$AIC),]  
  mods.aic.f$delta_AIC <- mods.aic.f$AIC - mods.aic.f$AIC[1]
  
                         
  mods.aic.f %>%
    kbl(digits = 3) %>%
    kable_styling(bootstrap_options = 'striped', font_size = 14, full_width = FALSE, position = 'left')
  

```

#### -- compare models (males)

```{r, echo=FALSE}

## Compare models

  #male
  mods.aic.m <- data.frame('model' = c('null','reproState','distance','reproState*dist'),
                           'AIC' = c(AIC(glm(cbind(nights_STOC_MALE, duration) ~ 1, 
                                             data = daysMerge, family = binomial)),
                                     AIC(male.prop.repro), 
                                     AIC(male.prop.dist),
                                     AIC(male.prop.repro.dist)))
  mods.aic.m <- mods.aic.m[order(mods.aic.m$AIC),]  
  mods.aic.m$delta_AIC <- mods.aic.m$AIC - mods.aic.m$AIC[1]
  
                         
  mods.aic.m %>%
    kbl(digits = 3) %>%
    kable_styling(bootstrap_options = 'striped', font_size = 14, full_width = FALSE, position = 'left')
```

## 
