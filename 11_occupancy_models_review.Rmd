---
title: "Activity center occupancy models"
author: "Cara"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    keep_md: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(data.table)
library(unmarked)
library(ggplot2)
library(reshape2)
library(dplyr)
library(kableExtra)
```

--------------------------------------------------------------------------------

### Occupancy models for analyzing spotted owl activity center ("big grid") data from 2021-2022


--------------------------------------------------------------------------------
## 
#### Load site-level covariate data

```{r echo=FALSE}

  ## Site-level covariates
  site_covars <- fread('output/10_occ_covariates/10_site_level_2021-2022.csv')

    ## Make sure they're sorted alphabetically by site
    site_covars$year_site <- paste(site_covars$year, site_covars$site_stn, sep = '_')
    site_covars <- site_covars[order(site_covars$year_site),]
  
    #also need Barred owl and NR habitat covariates
    
    head(site_covars[,c('year_site','site_name','repro_state','nested','duration','dist_actual')])
      
```

## 
#### Load observation-level covariate data
##### -effort (recording minutes)
##### -noise (mean SPL)

```{r echo=FALSE}

  ## Observation-level covariates
  effort <- fread('output/10_occ_covariates/10_effort_weekly_raw_21-22.csv', header = TRUE)
  noise  <- fread('output/10_occ_covariates/10_noise_weekly_raw_21-22.csv', header = TRUE)
  
    ## Make sure sites are sorted alphabetically, then delete that column
    effort$year_site <- paste(effort$year, effort$site_name, sep = '_')
      effort <- effort[order(effort$year_site),]
      effort_covar <- effort[,-c('V1','site_name','year','year_site')]
      head(effort_covar)
        
    noise$year_site <- paste(noise$year, noise$site_name, sep = '_')
      noise <- noise[order(noise$year_site),]
      noise_covar <- noise[,-c('V1','site_name','year','year_site')]
      head(noise_covar)
      
    ## Replace NAs with mean value (0)
    effort_mean <- mean(unlist(effort_covar), na.rm = TRUE)
      effort_covar[is.na(effort_covar)] <- effort_mean
    noise_mean <- mean(unlist(noise_covar),na.rm = TRUE)
      noise_covar[is.na(noise_covar)] <- noise_mean
    
    ## Format some site-level as observation-level
    dist_obs_covar <- matrix(data = site_covars$dist_actual, nrow = 291, ncol = 21)
    nest_obs_covar <- matrix(data = site_covars$nested, nrow = 291, ncol = 21)
    site_obs_covar <- matrix(data = site_covars$site_name, nrow = 291, ncol = 21)
    
    ## Create time-varying covariate
    time <- matrix(paste('wk', rep(1:ncol(effort_covar)), sep = '_'),
                   nrow = nrow(effort_covar),
                   ncol = ncol(effort_covar), 
                   byrow = TRUE)
    
```

##
#### Load detection histories

```{r, echo=FALSE}
    
  ## Any detections of all owls, females, and males
  dh_any    <- fread('output/08_weekly_dethist_left/08_dh_ac_combined_stocAny_left.csv')
  dh_female <- fread('output/08_weekly_dethist_left/08_dh_ac_combined_stocFemale_left.csv')
  dh_male   <- fread('output/08_weekly_dethist_left/08_dh_ac_combined_stocMale_left.csv')
  
    #Example:
    dh_any
    
  ## FNLC and pair detections only for females and males
  dh_female_fnlcp <- fread('output/08_weekly_dethist_left/08_dh_ac_combined_stocFemaleFNLCorPair_left.csv')
  dh_male_fnlcp   <- fread('output/08_weekly_dethist_left/08_dh_ac_combined_stocMaleFNLCorPair_left.csv')
  dh_female_fnlc <- fread('output/08_weekly_dethist_left/08_dh_ac_combined_stocFemaleFNLC_left.csv')
  dh_male_fnlc   <- fread('output/08_weekly_dethist_left/08_dh_ac_combined_stocMaleFNLC_left.csv')
  
  ## Make sure sites are sorted alphabetically, then delete that column  
  dh_any    <- dh_any[order(dh_any$V1,)];      dh_any <- dh_any[,-c('V1')]
  dh_female <- dh_female[order(dh_female$V1)]; dh_female <- dh_female[,-c('V1')]
  dh_male   <- dh_male[order(dh_male$V1)];     dh_male <- dh_male[,-c('V1')]
  dh_female_fnlcp <- dh_female_fnlcp[order(dh_female_fnlcp$V1)]; dh_female_fnlcp <- dh_female_fnlcp[,-c('V1')]
  dh_male_fnlcp   <- dh_male_fnlcp[order(dh_male_fnlcp$V1)];     dh_male_fnlcp <- dh_male_fnlcp[,-c('V1')]
  dh_female_fnlc <- dh_female_fnlc[order(dh_female_fnlc$V1)]; dh_female_fnlc <- dh_female_fnlc[,-c('V1')]  
  dh_male_fnlc   <- dh_male_fnlc[order(dh_male_fnlc$V1)];     dh_male_fnlc <- dh_male_fnlc[,-c('V1')]

```

##
#### Create input files and view naive detections
#### 
##### Also comparing different response variables for females and males
##### - FNLC = four-note location calls only (no irregular calls)
##### - FNLC/pair = FNLC or pair detections (no irregular calls)
##### Looks like there's not much difference between "any" and FNLC/pair, so use FNLC/pair

```{r echo=FALSE, warning=FALSE}

  input_any <- unmarkedFrameOccu(y = dh_any, obsCovs = list(effort = effort_covar,
                                                            noise = noise_covar,
                                                            dist = dist_obs_covar,
                                                            nest = nest_obs_covar,
                                                            site = site_obs_covar, 
                                                            time = time), siteCovs = site_covars)
    
  input_female <- unmarkedFrameOccu(y = dh_female, obsCovs = list(effort = effort_covar,
                                                                  noise = noise_covar,
                                                                  dist = dist_obs_covar,
                                                                  nest = nest_obs_covar,
                                                                  site = site_obs_covar,
                                                                  time = time), siteCovs = site_covars)
     
  input_female_fnlcp <- unmarkedFrameOccu(y = dh_female_fnlcp, obsCovs = list(effort = effort_covar,
                                                                  noise = noise_covar,
                                                                  dist = dist_obs_covar,
                                                                  nest = nest_obs_covar,
                                                                  site = site_obs_covar,
                                                                  time = time), siteCovs = site_covars)
   
  input_female_fnlc <- unmarkedFrameOccu(y = dh_female_fnlc, obsCovs = list(effort = effort_covar,
                                                                            noise = noise_covar,
                                                                            dist = dist_obs_covar,
                                                                            nest = nest_obs_covar,
                                                                            site = site_obs_covar,
                                                                            time = time), 
                                         siteCovs = site_covars)
    
  input_male <- unmarkedFrameOccu(y = dh_male, obsCovs = list(effort = effort_covar,
                                                              noise = noise_covar,
                                                              dist = dist_obs_covar,
                                                              nest = nest_obs_covar,
                                                              site = site_obs_covar,
                                                              time = time), siteCovs = site_covars) 
    
  input_male_fnlcp <- unmarkedFrameOccu(y = dh_male_fnlcp, obsCovs = list(effort = effort_covar,
                                                              noise = noise_covar,
                                                              dist = dist_obs_covar,
                                                              nest = nest_obs_covar,
                                                              site = site_obs_covar,
                                                              time = time), siteCovs = site_covars)  
    
  input_male_fnlc <- unmarkedFrameOccu(y = dh_male_fnlc, obsCovs = list(effort = effort_covar,
                                                                        noise = noise_covar,
                                                                        dist = dist_obs_covar,
                                                                        nest = nest_obs_covar,
                                                                        site = site_obs_covar,
                                                                        time = time), siteCovs = site_covars)  
  
  #View naive occupancy rates
  naive <- data.frame('detection_type' = c('All STOC', 
                                           'Female STOC (all calls)', 'Female STOC (FNLC/pair)', 
                                           'Female STOC (FNLC only)','Male STOC (all calls)',
                                           'Male STOC (FNLC/pair)','Male STOC (FNLC only)'), 
                      'naive_occupancy' = c(sum(rowSums(input_any@y, na.rm = TRUE) > 0) / nrow(input_any@y),
                                         sum(rowSums(input_female@y, na.rm = TRUE) > 0) / nrow(input_female@y),
                                         sum(rowSums(input_female_fnlcp@y,
                                                     na.rm=TRUE)>0)/nrow(input_female_fnlcp@y),
                                         sum(rowSums(input_female_fnlc@y,
                                                     na.rm=TRUE)>0)/nrow(input_female_fnlc@y),
                                         sum(rowSums(input_male@y, na.rm = TRUE) > 0) / nrow(input_male@y),
                                         sum(rowSums(input_male_fnlcp@y, na.rm = TRUE) > 0) /
                                           nrow(input_male_fnlcp@y),
                                         sum(rowSums(input_male_fnlc@y, na.rm = TRUE) > 0) /
                                           nrow(input_male_fnlc@y)))
  
  #View detection history plots
  plot(input_any, main = paste('All STOC \n (naive occ = ', 
                               round(naive[naive$detection_type %in% 'All STOC',]$naive_occupancy, 2), ')', 
                               sep = ''))
  plot(input_female, main = paste('Female STOC (any)\n (naive occ = ', 
                                  round(naive[naive$detection_type %in% 'Female STOC (all calls)',]$naive_occupancy,
                                        2),')',
                                  sep = ''))
  plot(input_female_fnlcp, main = paste('Female STOC (FNLC/pair)\n (naive occ = ', 
                               round(naive[naive$detection_type %in% 'Female STOC (FNLC/pair)',]$naive_occupancy, 2),
                               ')', sep = ''))
  plot(input_female_fnlc, main = paste('Female STOC (FNLC only)\n (naive occ = ', 
                               round(naive[naive$detection_type %in% 'Female STOC (FNLC only)',]$naive_occupancy, 2),
                               ')', sep = ''))
  plot(input_male, main = paste('Male STOC (any)\n (naive occ = ', 
                               round(naive[naive$detection_type %in% 'Male STOC (all calls)',]$naive_occupancy, 2),
                               ')', sep = ''))
  plot(input_male_fnlcp, main = paste('Male STOC (FNLC/pair) \n (naive occ = ', 
                               round(naive[naive$detection_type %in% 'Male STOC (FNLC/pair)',]$naive_occupancy, 2),
                               ')', sep = ''))
  plot(input_male_fnlc, main = paste('Male STOC (FNLC only) \n (naive occ = ', 
                               round(naive[naive$detection_type %in% 'Male STOC (FNLC only)',]$naive_occupancy, 2),
                               ')', sep = ''))
  
  # naive %>%
  #   kbl(digits = 3) %>%
  #   kable_styling(bootstrap_options = 'striped', font_size = 14, full_width = FALSE, position = 'left')
  
```

##
#### Run and compare models (constant psi)

##### - All detections
```{r, echo=FALSE}
#ANY detections (constant psi)
    p1_any <- occu(~1                                         ~1, data = input_any)
    p2_any <- occu(~scale(dist)                               ~1, data = input_any)
    p3_any <- occu(~scale(dist) + site                        ~1, data = input_any)
    p4_any <- occu(~scale(dist) +        nest                 ~1, data = input_any)
    p5_any <- occu(~scale(dist) +               scale(effort) ~1, data = input_any)
    p6_any <- occu(~                            scale(effort) ~1, data = input_any)
    p7_any <- occu(~scale(dist) + site +        scale(effort) ~1, data = input_any) #top model
    p8_any <- occu(~scale(dist) +        nest + scale(effort) ~1, data = input_any)
    
    modList_any <- fitList('p(.), psi(.)}' = p1_any,
                       'p(dist), psi(.)' = p2_any,
                       'p(dist + site), psi(.)' = p3_any,
                       'p(dist + nest), psi(.)' = p4_any,
                       'p(dist + effort), psi(.)' = p5_any,
                       'p(effort), psi(.)' = p6_any,
                       'p(dist + site + effort), psi(.)' = p7_any, #top mod
                       'p(dist + nest + effort), psi(.)' = p8_any) 
    modSel(modList_any)
    
```

## 
##### - Female detections (any calls)
```{r, echo=FALSE}
#FEMALE detections (constant psi)
    p1_fem <- occu(~1                                         ~1, data = input_female)
    p2_fem <- occu(~scale(dist)                               ~1, data = input_female)
    p3_fem <- occu(~scale(dist) + site                        ~1, data = input_female)
    p4_fem <- occu(~scale(dist) +        nest                 ~1, data = input_female)
    p5_fem <- occu(~scale(dist) +               scale(effort) ~1, data = input_female)
    p6_fem <- occu(~                            scale(effort) ~1, data = input_female)
    p7_fem <- occu(~scale(dist) + site +        scale(effort) ~1, data = input_female) #top model
    p8_fem <- occu(~scale(dist) +        nest + scale(effort) ~1, data = input_female)
    
    modList_fem <- fitList('p(.), psi(.)}' = p1_fem,
                       'p(dist), psi(.)' = p2_fem,
                       'p(dist + site), psi(.)' = p3_fem,
                       'p(dist + nest), psi(.)' = p4_fem,
                       'p(dist + effort), psi(.)' = p5_fem,
                       'p(effort), psi(.)' = p6_fem,
                       'p(dist + site + effort), psi(.)' = p7_fem, #top mod
                       'p(dist + nest + effort), psi(.)' = p8_fem) 
    modSel(modList_fem)
    
```

## 
##### - Female detections (FNLC or pair)
```{r, echo=FALSE}
#FEMALE (FNLC or pair) detections (constant psi)
    p1_fem_fnlcp <- occu(~1                                         ~1, data = input_female_fnlcp)
    p2_fem_fnlcp <- occu(~scale(dist)                               ~1, data = input_female_fnlcp)
    p3_fem_fnlcp <- occu(~scale(dist) + site                        ~1, data = input_female_fnlcp)
    p4_fem_fnlcp <- occu(~scale(dist) +               nest          ~1, data = input_female_fnlcp)
    p5_fem_fnlcp <- occu(~dist +                      scale(effort) ~1, data = input_female_fnlcp)
    p6_fem_fnlcp <- occu(~                            scale(effort) ~1, data = input_female_fnlcp)
    p7_fem_fnlcp <- occu(~scale(dist) + site +        scale(effort) ~1, data = input_female_fnlcp) #top model
    p8_fem_fnlcp <- occu(~scale(dist) +        nest + scale(effort) ~1, data = input_female_fnlcp)
    
    modList_fem_fnlcp <- fitList('p(.), psi(.)}' = p1_fem_fnlcp,
                       'p(dist), psi(.)' = p2_fem_fnlcp,
                       'p(dist + site), psi(.)' = p3_fem_fnlcp,
                       'p(dist + nest), psi(.)' = p4_fem_fnlcp,
                       'p(dist + effort), psi(.)' = p5_fem_fnlcp,
                       'p(effort), psi(.)' = p6_fem_fnlcp,
                       'p(dist + site + effort), psi(.)' = p7_fem_fnlcp, #top mod
                       'p(dist + nest + effort), psi(.)' = p8_fem_fnlcp) 
    modSel(modList_fem_fnlcp)
    
```

## 
##### - Female detections (FNLC only)
```{r, echo=FALSE}
#FEMALE (FNLC or pair) detections (constant psi)
    p1_fem_fnlc <- occu(~1                                         ~1, data = input_female_fnlc)
    p2_fem_fnlc <- occu(~scale(dist)                               ~1, data = input_female_fnlc)
    p3_fem_fnlc <- occu(~scale(dist) + site                        ~1, data = input_female_fnlc)
    p4_fem_fnlc <- occu(~scale(dist) +        nest                 ~1, data = input_female_fnlc)
    p5_fem_fnlc <- occu(~scale(dist) +               scale(effort) ~1, data = input_female_fnlc)
    p6_fem_fnlc <- occu(~                            scale(effort) ~1, data = input_female_fnlc)
    p7_fem_fnlc <- occu(~scale(dist) + site +        scale(effort) ~1, data = input_female_fnlc) #top model
    p8_fem_fnlc <- occu(~scale(dist) +        nest + scale(effort) ~1, data = input_female_fnlc)
    
    modList_fem_fnlc <- fitList('p(.), psi(.)' = p1_fem_fnlc,
                                 'p(dist), psi(.)' = p2_fem_fnlc,
                                 'p(dist + site), psi(.)' = p3_fem_fnlc,
                                 'p(dist + nest), psi(.)' = p4_fem_fnlc,
                                 'p(dist + effort), psi(.)' = p5_fem_fnlc,
                                 'p(effort), psi(.)' = p6_fem_fnlc,
                                 'p(dist + site + effort), psi(.)' = p7_fem_fnlc, #top mod
                                 'p(dist + nest + effort), psi(.)' = p8_fem_fnlc) 
    modSel(modList_fem_fnlc)
    
```

## 
##### - Male detections (any calls)
```{r, echo=FALSE}
#MALE detections (constant psi)
    p1_mal <- occu(~1                                         ~1, data = input_male)
    p2_mal <- occu(~scale(dist)                               ~1, data = input_male)
    p3_mal <- occu(~scale(dist) + site                        ~1, data = input_male)
    p4_mal <- occu(~scale(dist) +        nest                 ~1, data = input_male)
    p5_mal <- occu(~scale(dist) +               scale(effort) ~1, data = input_male)
    p6_mal <- occu(~                            scale(effort) ~1, data = input_male)
    p7_mal <- occu(~scale(dist) + site +        scale(effort) ~1, data = input_male) #top model
    p8_mal <- occu(~scale(dist) +        nest + scale(effort) ~1, data = input_male)
    
    modList_mal <- fitList('p(.), psi(.)' = p1_mal,
                                 'p(dist), psi(.)' = p2_mal,
                                 'p(dist + site), psi(.)' = p3_mal,
                                 'p(dist + nest), psi(.)' = p4_mal,
                                 'p(dist + effort), psi(.)' = p5_mal,
                                 'p(effort), psi(.)' = p6_mal,
                                 'p(dist + site + effort), psi(.)' = p7_mal, #top mod
                                 'p(dist + nest + effort), psi(.)' = p8_mal) 
    modSel(modList_fem_fnlcp)
    
```

## 
##### - Male detections (FNLC or pair)
```{r, echo=FALSE}
#MALE (FNLC or pair) detections (constant psi)
    p1_mal_fnlcp <- occu(~1                                         ~1, data = input_male_fnlcp)
    p2_mal_fnlcp <- occu(~scale(dist)                               ~1, data = input_male_fnlcp)
    p3_mal_fnlcp <- occu(~scale(dist) + site                        ~1, data = input_male_fnlcp)
    p4_mal_fnlcp <- occu(~scale(dist) +        nest                 ~1, data = input_male_fnlcp)
    p5_mal_fnlcp <- occu(~scale(dist) +               scale(effort) ~1, data = input_male_fnlcp)
    p6_mal_fnlcp <- occu(~                            scale(effort) ~1, data = input_male_fnlcp)
    p7_mal_fnlcp <- occu(~scale(dist) + site +        scale(effort) ~1, data = input_male_fnlcp) #top model
    p8_mal_fnlcp <- occu(~scale(dist) +        nest + scale(effort) ~1, data = input_male_fnlcp)
    
    modList_mal_fnlcp <- fitList('p(.), psi(.)' = p1_mal_fnlcp,
                                 'p(dist), psi(.)' = p2_mal_fnlcp,
                                 'p(dist + site), psi(.)' = p3_mal_fnlcp,
                                 'p(dist + nest), psi(.)' = p4_mal_fnlcp,
                                 'p(dist + effort), psi(.)' = p5_mal_fnlcp,
                                 'p(effort), psi(.)' = p6_mal_fnlcp,
                                 'p(dist + site + effort), psi(.)' = p7_mal_fnlcp, #top mod
                                 'p(dist + nest + effort), psi(.)' = p8_mal_fnlcp) 
    modSel(modList_mal_fnlcp)
    
```

## 
##### - Male detections (FNLC only)
```{r, echo=FALSE}
#MALE (FNLC only) detections (constant psi)
    p1_mal_fnlc <- occu(~1                                         ~1, data = input_male_fnlc)
    p2_mal_fnlc <- occu(~scale(dist)                               ~1, data = input_male_fnlc)
    p3_mal_fnlc <- occu(~scale(dist) + site                        ~1, data = input_male_fnlc)
    p4_mal_fnlc <- occu(~scale(dist) +        nest                 ~1, data = input_male_fnlc)
    p5_mal_fnlc <- occu(~scale(dist) +               scale(effort) ~1, data = input_male_fnlc)
    p6_mal_fnlc <- occu(~                            scale(effort) ~1, data = input_male_fnlc)
    p7_mal_fnlc <- occu(~scale(dist) + site +        scale(effort) ~1, data = input_male_fnlc) #top model
    p8_mal_fnlc <- occu(~scale(dist) +        nest + scale(effort) ~1, data = input_male_fnlc)
    
    modList_mal_fnlc <- fitList('p(.), psi(.)' = p1_mal_fnlc,
                           'p(dist), psi(.)' = p2_mal_fnlc,
                           'p(dist + site), psi(.)' = p3_mal_fnlc,
                           'p(dist + nest), psi(.)' = p4_mal_fnlc,
                           'p(dist + effort), psi(.)' = p5_mal_fnlc,
                           'p(effort), psi(.)' = p6_mal_fnlc,
                           'p(dist + site + effort), psi(.)' = p7_mal_fnlc, #top mod
                           'p(dist + nest + effort), psi(.)' = p8_mal_fnlc) 
    modSel(modList_mal_fnlc)  

```

## 
#### Compare parameter estimates from models with different call types (top models from above)
```{r, echo=FALSE}

    p7_any

    p7_fem
    
    p7_fem_fnlcp
    
    p7_fem_fnlc
    
    p7_mal
    
    p7_mal_fnlcp

    p7_mal_fnlc

```


##
#### Create marginal plots (by site): p(dist + site + effort)
```{r, echo=FALSE}

    #format covariate values to predict on
    dist_grid   <- sort(c(mean(site_covars$dist_actual), seq(min(site_covars$dist_actual),
                                                             max(site_covars$dist_actual), length = 50)))
    effort_grid <- sort(c(0, effort_mean, seq(min(effort_covar), max(effort_covar), length = 49)))
    site_grid   <- unique(site_covars$site_name) 
    
      new_covar <- expand.grid('dist' = dist_grid, 'effort' = effort_grid, 'site' = site_grid)
    
    #predict
    det_pred_p7any <- predict(p7_any, type = 'det', new_covar)
    det_pred_p7fem <- predict(p7_fem_fnlcp, type = 'det', new_covar)
    det_pred_p7mal <- predict(p7_mal_fnlc, type = 'det', new_covar)
    
    occ_pred_p7any <- predict(p7_any, type = 'state', new_covar)
    occ_pred_p7fem <- predict(p7_fem_fnlc, type = 'state', new_covar)
    occ_pred_p7mal <- predict(p7_mal_fnlc, type = 'state', new_covar)

    #format 'effort' by site for plotting
    effort$site <- sapply(strsplit(effort$site_name, '\\_'), '[', 1)
    effort_dc <- data.frame('site' = 'DC',
                                'effort' = unlist(effort[, c(3:22,24)][effort$site %in% 'DC',]))
    effort_mc <- data.frame('site' = 'MC',
                                'effort' = unlist(effort[, c(3:22,24)][effort$site %in% 'MC',]))
    effort_ug <- data.frame('site' = 'UG',
                                'effort' = unlist(effort[, c(3:22,24)][effort$site %in% 'UG',]))
    effort_wc <- data.frame('site' = 'WC',
                                'effort' = unlist(effort[, c(3:22,24)][effort$site %in% 'WC',]))
    effort_bc <- data.frame('site' = 'BC',
                                'effort' = unlist(effort[, c(3:22,24)][effort$site %in% 'BC',]))
    effort_cc <- data.frame('site' = 'CC',
                                'effort' = unlist(effort[, c(3:22,24)][effort$site %in% 'CC',]))
    effort_lm <- data.frame('site' = 'LM',
                                'effort' = unlist(effort[, c(3:22,24)][effort$site %in% 'LM',]))
    effort_df <- do.call('rbind', list(effort_dc, effort_mc, effort_ug, effort_wc,
                                           effort_bc, effort_cc, effort_lm))
    
    #Combine covariates with predictions
    pred_wide_any <- cbind(new_covar, 'det' = det_pred_p7any$Predicted, 'occ' = occ_pred_p7any$Predicted)
    lci_wide_any  <- cbind(new_covar, 'det' = det_pred_p7any$lower, 'occ' = occ_pred_p7any$lower)
    uci_wide_any  <- cbind(new_covar, 'det' = det_pred_p7any$upper, 'occ' = occ_pred_p7any$upper)
 
    pred_long_any <- melt(pred_wide_any, id.vars = c('dist','effort','site'), value.name = 'value')
    lci_long_any  <- melt(lci_wide_any, id.vars = c('dist','effort','site'), value.name = 'LCI')
    uci_long_any  <- melt(uci_wide_any, id.vars = c('dist','effort','site'), value.name = 'UCI')
    
      plot_data_any <- cbind(pred_long_any, 'LCI' = lci_long_any$LCI, 'UCI' = uci_long_any$UCI)

    pred_wide_fem <- cbind(new_covar, 'det' = det_pred_p7fem$Predicted, 'occ' = occ_pred_p7fem$Predicted)
    lci_wide_fem  <- cbind(new_covar, 'det' = det_pred_p7fem$lower, 'occ' = occ_pred_p7fem$lower)
    uci_wide_fem  <- cbind(new_covar, 'det' = det_pred_p7fem$upper, 'occ' = occ_pred_p7fem$upper)
    
    pred_long_fem <- melt(pred_wide_fem, id.vars = c('dist','effort','site'), value.name = 'value')
    lci_long_fem  <- melt(lci_wide_fem, id.vars = c('dist','effort','site'), value.name = 'LCI')
    uci_long_fem  <- melt(uci_wide_fem, id.vars = c('dist','effort','site'), value.name = 'UCI')
    
      plot_data_fem <- cbind(pred_long_fem, 'LCI' = lci_long_fem$LCI, 'UCI' = uci_long_fem$UCI)
    
    pred_wide_mal <- cbind(new_covar, 'det' = det_pred_p7mal$Predicted, 'occ' = occ_pred_p7mal$Predicted)
    lci_wide_mal  <- cbind(new_covar, 'det' = det_pred_p7mal$lower, 'occ' = occ_pred_p7mal$lower)
    uci_wide_mal  <- cbind(new_covar, 'det' = det_pred_p7mal$upper, 'occ' = occ_pred_p7mal$upper)
    
    pred_long_mal <- melt(pred_wide_mal, id.vars = c('dist','effort','site'), value.name = 'value')
    lci_long_mal  <- melt(lci_wide_mal, id.vars = c('dist','effort','site'), value.name = 'LCI')
    uci_long_mal  <- melt(uci_wide_mal, id.vars = c('dist','effort','site'), value.name = 'UCI')
    
      plot_data_mal <- cbind(pred_long_mal, 'LCI' = lci_long_mal$LCI, 'UCI' = uci_long_mal$UCI)

  #Plot    
    plot_data_any$group <- 'Any'; plot_data_fem$group <- 'Female'; plot_data_mal$group <- 'Male'
    plot_combine <- do.call('rbind', list(plot_data_any, plot_data_fem, plot_data_mal))
    site_covars$site <- site_covars$site_name
    
    #All together
    plot_p7_dist <- ggplot(plot_combine[plot_combine$effort == effort_mean & plot_combine$variable %in% 'det',], 
                              aes(x = dist/1000, y = value, color = group, fill = group)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3, color = NA) + #color=NA to remove outlines
      ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Distance (km)') +
      ggtitle('p(distance + effort + site) psi(.)') +
      geom_rug(data = site_covars, aes(x = dist_actual/1000), inherit.aes = FALSE) +
      facet_grid(~ site) + theme_bw()
    plot_p7_dist
    
    #All detections
    plot_p7any_dist <- ggplot(plot_data_any[plot_data_any$effort == effort_mean & 
                                              plot_data_any$variable %in% 'det',], 
                         aes(x = dist/1000, y = value)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3) +
      # ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Distance (km)') +
      ggtitle('All detections: p(distance + effort + site) psi(.)') +
      geom_rug(data = site_covars, aes(x = dist_intended/1000), inherit.aes = FALSE) +
      facet_grid(~ site) + theme_bw()
    plot_p7any_dist
    
    plot_p7any_effort <- ggplot(plot_data_any[plot_data_any$dist == mean(site_covars$dist_actual) &
                                                plot_data_any$variable %in% 'det',], 
                         aes(x = effort, y = value)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3) +
      ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Effort') +
      ggtitle('All detections: p(distance + effort + site) psi(.)') +
      # geom_rug(data = effort_df, aes(x = effort), inherit.aes = FALSE) +
      facet_grid(~ site) + theme_bw()
    plot_p7any_effort
    
```
## 
## 
Ok, there is really just one outlier at Miller Creek (MC) with very large effort. 
Should truncate that or replace with mean.
There shouldn't be *this* strong of a relationship with effort (it was pretty constant)



##
#### Create marginal plots (grouped): p(dist)
```{r, echo=FALSE}

  # p2_any@call
  # head(new_covar)

  #format distance covar
  dist_covar <- data.frame('dist' = new_covar$dist)
  
    #predict
    det_pred_2any <- predict(p2_any, type = 'det', dist_covar)
    det_pred_2fem <- predict(p2_fem_fnlcp, type = 'det', dist_covar)
    det_pred_2mal <- predict(p2_mal_fnlcp, type = 'det', dist_covar)
    
    occ_pred_2any <- predict(p2_any, type = 'state', dist_covar)
    occ_pred_2fem <- predict(p2_fem_fnlcp, type = 'state', dist_covar)
    occ_pred_2mal <- predict(p2_mal_fnlcp, type = 'state', dist_covar)
    
    #Combine covariates with predictions
    pred_wide_any <- cbind(dist_covar, 'det' = det_pred_2any$Predicted, 'occ' = occ_pred_2any$Predicted)
    lci_wide_any  <- cbind(dist_covar, 'det' = det_pred_2any$lower, 'occ' = det_pred_2any$lower)
    uci_wide_any  <- cbind(dist_covar, 'det' = det_pred_2any$upper, 'occ' = det_pred_2any$upper)
    
    pred_long_any <- melt(pred_wide_any, id.vars = c('dist'), value.name = 'value')
    lci_long_any  <- melt(lci_wide_any, id.vars = c('dist'), value.name = 'LCI')
    uci_long_any  <- melt(uci_wide_any, id.vars = c('dist'), value.name = 'UCI')
    
      plot_data_any <- cbind(pred_long_any, 'LCI' = lci_long_any$LCI, 'UCI' = uci_long_any$UCI)
    
    pred_wide_fem <- cbind(dist_covar, 'det' = det_pred_2fem$Predicted, 'occ' = occ_pred_2fem$Predicted)
    lci_wide_fem  <- cbind(dist_covar, 'det' = det_pred_2fem$lower, 'occ' = det_pred_2fem$lower)
    uci_wide_fem  <- cbind(dist_covar, 'det' = det_pred_2fem$upper, 'occ' = det_pred_2fem$upper)
    
    pred_long_fem <- melt(pred_wide_fem, id.vars = c('dist'), value.name = 'value')
    lci_long_fem  <- melt(lci_wide_fem, id.vars = c('dist'), value.name = 'LCI')
    uci_long_fem  <- melt(uci_wide_fem, id.vars = c('dist'), value.name = 'UCI')
      
      plot_data_fem <- cbind(pred_long_fem, 'LCI' = lci_long_fem$LCI, 'UCI' = uci_long_fem$UCI)
  
    pred_wide_mal <- cbind(dist_covar, 'det' = det_pred_2mal$Predicted, 'occ' = occ_pred_2mal$Predicted)
    lci_wide_mal  <- cbind(dist_covar, 'det' = det_pred_2mal$lower, 'occ' = det_pred_2mal$lower)
    uci_wide_mal  <- cbind(dist_covar, 'det' = det_pred_2mal$upper, 'occ' = det_pred_2mal$upper)
    
    pred_long_mal <- melt(pred_wide_mal, id.vars = c('dist'), value.name = 'value')
    lci_long_mal  <- melt(lci_wide_mal, id.vars = c('dist'), value.name = 'LCI')
    uci_long_mal  <- melt(uci_wide_mal, id.vars = c('dist'), value.name = 'UCI')
      
      plot_data_mal <- cbind(pred_long_mal, 'LCI' = lci_long_mal$LCI, 'UCI' = uci_long_mal$UCI)

      
    #Plot    
    plot_data_any$group <- 'Any'; plot_data_fem$group <- 'Female'; plot_data_mal$group <- 'Male'
    plot_combine <- do.call('rbind', list(plot_data_any, plot_data_fem, plot_data_mal))
    
    #All together
    plot_p2_dist <- ggplot(plot_combine[plot_combine$variable %in% 'det',], 
                           aes(x = dist/1000, y = value, color = group, fill = group)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3, color = NA) + #color=NA to remove outlines
      ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Distance (km)') +
      ggtitle('p(distance) psi(.)') +
      geom_rug(data = site_covars, aes(x = dist_actual/1000), inherit.aes = FALSE) +
      # facet_grid(~ site) + 
      theme_bw()
    plot_p2_dist
    
      
```

##
#### Create marginal plots (by nest status): p(dist + nest)
```{r, echo=FALSE}

  # p4_any@call
  # head(new_covar)
  
  #create 'nest' covar
  nest_grid <- unique(site_covars$nested)
  nest_covar <- expand.grid('dist' = dist_grid, 'nest' = nest_grid)
  
    #predict
    det_pred_4any <- predict(p4_any, type = 'det', nest_covar)
    det_pred_4fem <- predict(p4_fem_fnlcp, type = 'det', nest_covar)
    det_pred_4mal <- predict(p4_mal_fnlcp, type = 'det', nest_covar)
    
    occ_pred_4any <- predict(p4_any, type = 'state', nest_covar)
    occ_pred_4fem <- predict(p4_fem_fnlcp, type = 'state', nest_covar)
    occ_pred_4mal <- predict(p4_mal_fnlcp, type = 'state', nest_covar)

    #Combine covariates with predictions
    pred_wide_any <- cbind(nest_covar, 'det' = det_pred_4any$Predicted, 'occ' = occ_pred_4any$Predicted)
    lci_wide_any  <- cbind(nest_covar, 'det' = det_pred_4any$lower, 'occ' = det_pred_4any$lower)
    uci_wide_any  <- cbind(nest_covar, 'det' = det_pred_4any$upper, 'occ' = det_pred_4any$upper)
    
    pred_long_any <- melt(pred_wide_any, id.vars = c('nest','dist'), value.name = 'value')
    lci_long_any  <- melt(lci_wide_any, id.vars = c('nest','dist'), value.name = 'LCI')
    uci_long_any  <- melt(uci_wide_any, id.vars = c('nest','dist'), value.name = 'UCI')
    
      plot_data_any <- cbind(pred_long_any, 'LCI' = lci_long_any$LCI, 'UCI' = uci_long_any$UCI)
    
    pred_wide_fem <- cbind(nest_covar, 'det' = det_pred_4fem$Predicted, 'occ' = occ_pred_4fem$Predicted)
    lci_wide_fem  <- cbind(nest_covar, 'det' = det_pred_4fem$lower, 'occ' = det_pred_4fem$lower)
    uci_wide_fem  <- cbind(nest_covar, 'det' = det_pred_4fem$upper, 'occ' = det_pred_4fem$upper)
    
    pred_long_fem <- melt(pred_wide_fem, id.vars = c('nest','dist'), value.name = 'value')
    lci_long_fem  <- melt(lci_wide_fem, id.vars = c('nest','dist'), value.name = 'LCI')
    uci_long_fem  <- melt(uci_wide_fem, id.vars = c('nest','dist'), value.name = 'UCI')
    
      plot_data_fem <- cbind(pred_long_fem, 'LCI' = lci_long_fem$LCI, 'UCI' = uci_long_fem$UCI)
    
    pred_wide_mal <- cbind(nest_covar, 'det' = det_pred_4mal$Predicted, 'occ' = occ_pred_4mal$Predicted)
    lci_wide_mal  <- cbind(nest_covar, 'det' = det_pred_4mal$lower, 'occ' = det_pred_4mal$lower)
    uci_wide_mal  <- cbind(nest_covar, 'det' = det_pred_4mal$upper, 'occ' = det_pred_4mal$upper)
    
    pred_long_mal <- melt(pred_wide_mal, id.vars = c('nest','dist'), value.name = 'value')
    lci_long_mal  <- melt(lci_wide_mal, id.vars = c('nest','dist'), value.name = 'LCI')
    uci_long_mal  <- melt(uci_wide_mal, id.vars = c('nest','dist'), value.name = 'UCI')
    
      plot_data_mal <- cbind(pred_long_mal, 'LCI' = lci_long_mal$LCI, 'UCI' = uci_long_mal$UCI)
  
      
    #Plot    
    plot_data_any$group <- 'Any'; plot_data_fem$group <- 'Female'; plot_data_mal$group <- 'Male'
    plot_combine <- do.call('rbind', list(plot_data_any, plot_data_fem, plot_data_mal))
    
    site_covars$nest <- site_covars$nested
    
    #All together
    plot_p4_dist <- ggplot(plot_combine[plot_combine$variable %in% 'det',], 
                           aes(x = dist/1000, y = value, color = group, fill = group)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3, color = NA) + #color=NA to remove outlines
      ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Distance (km)') +
      ggtitle('p(distance + nest) psi(.)') +
      geom_rug(data = site_covars, aes(x = dist_actual/1000), inherit.aes = FALSE) +
      facet_grid(~ nest) + theme_bw()
    plot_p4_dist
    

    plot_p4_dist2 <- ggplot(plot_combine[plot_combine$variable %in% 'det',], 
                           aes(x = dist/1000, y = value, color = nest, fill = nest)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3, color = NA) + #color=NA to remove outlines
      ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Distance (km)') +
      ggtitle('p(distance + nest) psi(.)') +
      geom_rug(data = site_covars, aes(x = dist_actual/1000), inherit.aes = FALSE) +
      facet_grid(~ group) + theme_bw()
    plot_p4_dist2
      
```

## 
### Try models with time-varying 'p'

```{r echo=FALSE, warning=FALSE}

  #ANY detections (constant psi) - time-varying p
    p1_any_time <- occu(~1                                  ~1, data = input_any)
    p2_any_time <- occu(~dist                        + time ~1, data = input_any)
    p3_any_time <- occu(~dist + site                 + time ~1, data = input_any) #top model
    p4_any_time <- occu(~dist +        nest          + time ~1, data = input_any)
    p5_any_time <- occu(~dist +               effort + time ~1, data = input_any) 
    p6_any_time <- occu(~                     effort + time ~1, data = input_any) 
    p7_any_time <- occu(~dist + site +        effort + time ~1, data = input_any) 
    p8_any_time <- occu(~dist +        nest + effort + time ~1, data = input_any)
    p9_any_time <- occu(~                              time ~1, data = input_any)
    
    modList_any_time <- fitList('p(.), psi(.)}' = p1_any_time,
                           'p(dist + time), psi(.)' = p2_any_time,
                           'p(dist + site + time), psi(.)' = p3_any_time, #top model
                           'p(dist + nest + time), psi(.)' = p4_any_time,
                           'p(dist + effort + time), psi(.)' = p5_any_time,
                           'p(effort) + time, psi(.)' = p6_any_time,
                           'p(dist + site + effort + time), psi(.)' = p7_any_time,
                           'p(dist + nest + effort + time), psi(.)' = p8_any_time,
                           'p(time), psi(.)' = p9_any_time) 
    modSel(modList_any_time)
    
    
  #FEMALE FNLCP detections (constant psi) - time-varying p
    p1_fem_fnlcp_time <- occu(~1                                  ~1, data = input_female_fnlcp)
    p2_fem_fnlcp_time <- occu(~dist                        + time ~1, data = input_female_fnlcp)
    p3_fem_fnlcp_time <- occu(~dist + site                 + time ~1, data = input_female_fnlcp) #top model
    p4_fem_fnlcp_time <- occu(~dist +        nest          + time ~1, data = input_female_fnlcp) 
    p5_fem_fnlcp_time <- occu(~dist +               effort + time ~1, data = input_female_fnlcp) #error (NAs in SE)
    p6_fem_fnlcp_time <- occu(~                     effort + time ~1, data = input_female_fnlcp)
    p7_fem_fnlcp_time <- occu(~dist + site +        effort + time ~1, data = input_female_fnlcp) #error (NAs in SE)
    p8_fem_fnlcp_time <- occu(~dist +        nest + effort + time ~1, data = input_female_fnlcp) #error (NAs in SE)
    p9_fem_fnlcp_time <- occu(~                              time ~1, data = input_female_fnlcp)
    
    modList_femFNLCP_time <- fitList('p(.), psi(.)}' = p1_fem_fnlcp_time,
                                'p(dist + time), psi(.)' = p2_fem_fnlcp_time,
                                'p(dist + site + time), psi(.)' = p3_fem_fnlcp_time, #top model
                                'p(dist + nest + time), psi(.)' = p4_fem_fnlcp_time,
                                'p(dist + effort + time), psi(.)' = p5_fem_fnlcp_time,
                                'p(effort) + time, psi(.)' = p6_fem_fnlcp_time,
                                'p(dist + site + effort + time), psi(.)' = p7_fem_fnlcp_time,
                                'p(dist + nest + effort + time), psi(.)' = p8_fem_fnlcp_time,
                                'p(time), psi(.)' = p9_fem_fnlcp_time) 
    # modSel(modList_femFNLCP_time)
    
    
  #MALE FNLC detections (constant psi) - time-varying p
    p1_mal_fnlcp_time <- occu(~1                                  ~1, data = input_male_fnlcp)
    p2_mal_fnlcp_time <- occu(~dist                        + time ~1, data = input_male_fnlcp)
    p3_mal_fnlcp_time <- occu(~dist + site                 + time ~1, data = input_male_fnlcp) #top model
    p4_mal_fnlcp_time <- occu(~dist +        nest          + time ~1, data = input_male_fnlcp) 
    p5_mal_fnlcp_time <- occu(~dist +               effort + time ~1, data = input_male_fnlcp) 
    p6_mal_fnlcp_time <- occu(~                     effort + time ~1, data = input_male_fnlcp) 
    p7_mal_fnlcp_time <- occu(~dist + site +        effort + time ~1, data = input_male_fnlcp) #error (NAs in SE)
    p8_mal_fnlcp_time <- occu(~dist +        nest + effort + time ~1, data = input_male_fnlcp) 
    p9_mal_fnlcp_time <- occu(~                              time ~1, data = input_male_fnlcp)
    
    modList_malFNLCP_time <- fitList('p(.), psi(.)}' = p1_mal_fnlcp_time,
                                     'p(dist + time), psi(.)' = p2_mal_fnlcp_time,
                                     'p(dist + site + time), psi(.)' = p3_mal_fnlcp_time, #top model
                                     'p(dist + nest + time), psi(.)' = p4_mal_fnlcp_time,
                                     'p(dist + effort + time), psi(.)' = p5_mal_fnlcp_time,
                                     'p(effort) + time, psi(.)' = p6_mal_fnlcp_time,
                                     'p(dist + site + effort + time), psi(.)' = p7_mal_fnlcp_time,
                                     'p(dist + nest + effort + time), psi(.)' = p8_mal_fnlcp_time,
                                     'p(time), psi(.)' = p9_mal_fnlcp_time) 
    # modSel(modList_malFNLCP_time) 
    
    
  #Examine results -- do this without site/nest first for simplicity [p(DIST + NEST + TIME) psi(.)]
    p2_any_time
    # p2_fem_fnlcp_time
    # p2_mal_fnlcp_time
    
  #Format covariates
    new_covar_time <- expand.grid('dist' = dist_grid, 'time' = as.character(unique(time)),
                                  'nest' = nest_grid)
    
  #Predict
    det_pred_p2any_time <- predict(p2_any_time, type = 'det', new_covar_time[,-3])
    det_pred_p2any_time_df <- cbind(new_covar_time, det_pred_p2any_time)

    det_pred_p2fem_time <- predict(p2_fem_fnlcp_time, type = 'det', new_covar_time[,-3])
    det_pred_p2fem_time_df <- cbind(new_covar_time, det_pred_p2fem_time)
    
    det_pred_p2mal_time <- predict(p2_mal_fnlcp_time, type = 'det', new_covar_time[,-3])
    det_pred_p2mal_time_df <- cbind(new_covar_time, det_pred_p2mal_time)
    
    p_by_week_any <- det_pred_p2any_time_df %>% group_by(time) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
    p_by_week_fem <- det_pred_p2fem_time_df %>% group_by(time) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
    p_by_week_mal <- det_pred_p2mal_time_df %>% group_by(time) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
```
   
##
#### Create marginal plots (grouped): p(dist + time)
  
```{r, echo = FALSE}    

  #Any
    plot_p2_dist_time_any <- ggplot(p_by_week_any, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2any_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci)) +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Any STOC): p(dist + time)') +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p2_dist_time_any
    
    # ggplot(det_pred_p2any_time_df, aes(x = time, y = Predicted)) +
    #   geom_boxplot(outlier.colour = 'black', outlier.shape = 16,
    #                outlier.size = 2, notch = TRUE) +
    #   ylim(0,1) +
    #   xlab('Week') + ylab('Detection probability') +
    #   ggtitle('Detection probability (Any STOC)') +
    #   theme_bw()
    
  #Female
    plot_p2_dist_time_fem <- ggplot(p_by_week_fem, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2fem_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci), color = 'tomato') +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Female STOC): p(dist + time)') +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p2_dist_time_fem
    
    # ggplot(det_pred_p2fem_time_df, aes(x = time, y = Predicted)) +
    #   geom_boxplot(outlier.colour = 'black', outlier.shape = 16,
    #                outlier.size = 2, notch = TRUE) +
    #   ylim(0,1) +
    #   xlab('Week') + ylab('Detection probability') +
    #   ggtitle('Detection probability (Female STOC)') +
    #   theme_bw()

  #Male
    plot_p2_dist_time_mal <- ggplot(p_by_week_mal, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2mal_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
                 # position = position_jitter(width = 0.1)) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci), color = 'cyan3') +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Male STOC): p(dist + time)') +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p2_dist_time_mal
    
    # ggplot(det_pred_p2mal_time_df, aes(x = time, y = Predicted)) +
    #   geom_boxplot(outlier.colour = 'black', outlier.shape = 16,
    #                outlier.size = 2, notch = TRUE) +
    #   ylim(0,1) +
    #   xlab('Week') + ylab('Detection probability') +
    #   ggtitle('Detection probability (Male STOC)') +
    #   theme_bw()

```

## 
#### Create marginal plots (by nest status): p(dist + nest + time)
```{r, echo = FALSE}
    
  #Examine results
  # p4_any_time
  # p4_fem_fnlcp_time
  # p4_mal_fnlcp_time
  
  #Predict
    det_pred_p4any_time <- predict(p4_any_time, type = 'det', new_covar_time)
    det_pred_p4any_time_df <- cbind(new_covar_time, det_pred_p4any_time)
    
    det_pred_p4fem_time <- predict(p4_fem_fnlcp_time, type = 'det', new_covar_time)
    det_pred_p4fem_time_df <- cbind(new_covar_time, det_pred_p4fem_time)
    
    det_pred_p4mal_time <- predict(p4_mal_fnlcp_time, type = 'det', new_covar_time)
    det_pred_p4mal_time_df <- cbind(new_covar_time, det_pred_p4mal_time)
    
    p_by_week_any <- det_pred_p4any_time_df %>% group_by(time, nest) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
    p_by_week_fem <- det_pred_p4fem_time_df %>% group_by(time, nest) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
    p_by_week_mal <- det_pred_p4mal_time_df %>% group_by(time, nest) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
  ## Plot
    
  #Any
    plot_p4_dist_time_any <- ggplot(p_by_week_any, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2any_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci)) +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Any STOC): p(dist + nest + time)') +
      facet_grid(~nest) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p4_dist_time_any

  #Female
    plot_p4_dist_time_fem <- ggplot(p_by_week_fem, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2fem_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci), color = 'tomato') +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Female STOC): p(dist + nest + time)') +
      facet_grid(~nest) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p4_dist_time_fem
    
  #Male
    plot_p4_dist_time_mal <- ggplot(p_by_week_mal, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2mal_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
      # position = position_jitter(width = 0.1)) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci), color = 'cyan3') +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Male STOC): p(dist + nest + time)') +
      facet_grid(~nest) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p4_dist_time_mal

    
```

