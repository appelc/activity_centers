---
title: "Activity center occupancy models"
author: "Cara"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    keep_md: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(data.table)
library(unmarked)
library(ggplot2)
library(reshape2)
library(dplyr)
library(kableExtra)
```

--------------------------------------------------------------------------------

### Occupancy models for analyzing spotted owl activity center ("big grid") data from 2021-2022


--------------------------------------------------------------------------------
## 
#### Load site-level covariate data

```{r echo=FALSE}

  ## Site-level covariates
  site_covars <- fread('output/10_occ_covariates/10_site_level_2021-2022.csv')

    ## Make sure they're sorted alphabetically by site
    site_covars$year_site <- paste(site_covars$year, site_covars$site_stn, sep = '_')
    site_covars <- site_covars[order(site_covars$year_site),]
  
    #also need Barred owl and NR habitat covariates
    
    head(site_covars[,c('year_site','site_name','repro_state','nested','duration','dist_actual')])
    
    #create a version without CC (site with single female)
    site_covars_noCC <- site_covars[!site_covars$site_name %in% 'CC',]
    
    
  ## Source functions
    source('scripts/11_occ_mod_functions.R')
      
```

## 
#### Load observation-level covariate data
##### -effort (recording minutes)
##### -noise (mean SPL)

```{r echo=FALSE}

  ## Observation-level covariates
  effort <- fread('output/10_occ_covariates/10_effort_weekly_raw_21-22.csv', header = TRUE)
  noise  <- fread('output/10_occ_covariates/10_noise_weekly_raw_21-22.csv', header = TRUE)
  
    ## Make sure sites are sorted alphabetically, then delete that column
    effort$year_site <- paste(effort$year, effort$site_name, sep = '_')
      effort <- effort[order(effort$year_site),]
      effort_covar <- effort[,-c('V1','site_name','year','year_site')]
      head(effort_covar)
        
      #get rid of MC12?? 
      
    noise$year_site <- paste(noise$year, noise$site_name, sep = '_')
      noise <- noise[order(noise$year_site),]
      noise_covar <- noise[,-c('V1','site_name','year','year_site')]
      head(noise_covar)
    
      #create versions without CC
      effort_noCC <- effort[!grepl('CC', effort$site_name),]
      effort_covar_noCC <- effort_noCC[,-c('V1','site_name','year','year_site')]
      
      noise_noCC <- noise[!grepl('CC', noise$site_name),]
      noise_covar_noCC <- noise_noCC[,-c('V1','site_name','year','year_site')]
        
    ## Replace NAs with mean value (0)
    effort_mean <- mean(unlist(effort_covar), na.rm = TRUE)
      effort_covar[is.na(effort_covar)] <- effort_mean
    noise_mean <- mean(unlist(noise_covar),na.rm = TRUE)
      noise_covar[is.na(noise_covar)] <- noise_mean
      
      #for versions without CC
      effort_noCC_mean <- mean(unlist(effort_covar_noCC), na.rm = TRUE)
        effort_covar_noCC[is.na(effort_covar_noCC)] <- effort_noCC_mean
      noise_noCC_mean <- mean(unlist(noise_covar_noCC),na.rm = TRUE)
        noise_covar_noCC[is.na(noise_covar_noCC)] <- noise_noCC_mean
      
    
    ## Format some site-level as observation-level
    dist_obs_covar <- matrix(data = site_covars$dist_actual, nrow = 291, ncol = 21)
    nest_obs_covar <- matrix(data = site_covars$nested, nrow = 291, ncol = 21)
    site_obs_covar <- matrix(data = site_covars$site_name, nrow = 291, ncol = 21)
    
      #without CC
      dist_obs_covar_noCC <- matrix(data = site_covars_noCC$dist_actual, nrow = 256, ncol = 21)
      nest_obs_covar_noCC <- matrix(data = site_covars_noCC$nested, nrow = 256, ncol = 21)
      site_obs_covar_noCC <- matrix(data = site_covars_noCC$site_name, nrow = 256, ncol = 21)
      
    
    ## Create time-varying covariate
    time <- matrix(paste('wk', rep(1:ncol(effort_covar)), sep = '_'),
                   nrow = nrow(effort_covar),
                   ncol = ncol(effort_covar), 
                   byrow = TRUE)
    
    time_noCC <- matrix(paste('wk', rep(1:ncol(effort_covar_noCC)), sep = '_'),
                        nrow = nrow(effort_covar_noCC),
                        ncol = ncol(effort_covar_noCC), 
                        byrow = TRUE)
    
    ## Read in pre-formatted long-format observation-level covariates
    effort_df <- fread('output/10_occ_covariates/10_effort_weekly_raw_21-22_long.csv', header = TRUE)
    noise_df <- fread('output/10_occ_covariates/10_noise_weekly_raw_21-22_long.csv', header = TRUE)
    
    #create versions without CC
    effort_df_noCC <- effort_df[!effort_df$site %in% 'CC',]
    noise_df_noCC  <- noise_df[!noise_df$site %in% 'CC',]
    
    
```

##
#### Load detection histories

```{r echo=FALSE}
    
  ## Any detections of all owls, females (FNLCP), and males (FNLCP)
  dh_any_csv    <- fread('output/08_weekly_dethist_left/08_dh_ac_combined_stocAny_left.csv')
  dh_female_csv <- fread('output/08_weekly_dethist_left/08_dh_ac_combined_stocFemaleFNLCorPair_left.csv')
  dh_male_csv   <- fread('output/08_weekly_dethist_left/08_dh_ac_combined_stocMaleFNLCorPair_left.csv')
  
    #Example:
    dh_any
 
  ## Make sure sites are sorted alphabetically, then delete that column  
  dh_any    <- dh_any_csv[order(dh_any_csv$V1),]; dh_any <- dh_any_csv[,-c('V1')]
  dh_female <- dh_female_csv[order(dh_female_csv$V1),]; dh_female <- dh_female_csv[,-c('V1')]
  dh_male   <- dh_male_csv[order(dh_male_csv$V1),]; dh_male <- dh_male_csv[,-c('V1')]
  
  ## Create versions without CC (site with single female)
  dh_any_csv_noCC <- dh_any_csv[!grepl('CC', dh_any_csv$V1),]
  dh_female_csv_noCC <- dh_female_csv[!grepl('CC', dh_female_csv$V1),]
  dh_male_csv_noCC <- dh_male_csv[!grepl('CC', dh_male_csv$V1),]

  dh_any_noCC <- dh_any_csv_noCC[order(dh_any_csv_noCC$V1),]; dh_any_noCC <- dh_any_csv_noCC[,-c('V1')]
  dh_female_noCC <- dh_female_csv_noCC[order(dh_female_csv_noCC$V1),]; dh_female_noCC <- dh_female_csv_noCC[,-c('V1')]
  dh_male_noCC   <- dh_male_csv_noCC[order(dh_male_csv_noCC$V1),]; dh_male_noCC <- dh_male_csv_noCC[,-c('V1')]
  
  
```

##
#### Create input files and view naive detections
#### 
```{r echo=FALSE, warning=FALSE}

  input_any <- unmarkedFrameOccu(y = dh_any, obsCovs = list(effort = effort_covar,
                                                            noise = noise_covar,
                                                            dist = dist_obs_covar,
                                                            nest = nest_obs_covar,
                                                            site = site_obs_covar, 
                                                            time = time), 
                                 siteCovs = site_covars)
    
  input_female <- unmarkedFrameOccu(y = dh_female, obsCovs = list(effort = effort_covar,
                                                                  noise = noise_covar,
                                                                  dist = dist_obs_covar,
                                                                  nest = nest_obs_covar,
                                                                  site = site_obs_covar,
                                                                  time = time), 
                                    siteCovs = site_covars)
     

  input_male <- unmarkedFrameOccu(y = dh_male, obsCovs = list(effort = effort_covar,
                                                              noise = noise_covar,
                                                              dist = dist_obs_covar,
                                                              nest = nest_obs_covar,
                                                              site = site_obs_covar,
                                                              time = time), 
                                  siteCovs = site_covars) 
  
  ## Create inputs without CC site
  input_any_noCC <- unmarkedFrameOccu(y = dh_any_noCC, obsCovs = list(effort = effort_covar_noCC,
                                                            noise = noise_covar_noCC,
                                                            dist = dist_obs_covar_noCC,
                                                            nest = nest_obs_covar_noCC,
                                                            site = site_obs_covar_noCC, 
                                                            time = time_noCC), 
                                 siteCovs = site_covars_noCC)
  
  input_female_noCC <- unmarkedFrameOccu(y = dh_female_noCC, obsCovs = list(effort = effort_covar_noCC,
                                                                  noise = noise_covar_noCC,
                                                                  dist = dist_obs_covar_noCC,
                                                                  nest = nest_obs_covar_noCC,
                                                                  site = site_obs_covar_noCC,
                                                                  time = time_noCC), 
                                    siteCovs = site_covars_noCC)
  
  
  input_male_noCC <- unmarkedFrameOccu(y = dh_male_noCC, obsCovs = list(effort = effort_covar_noCC,
                                                              noise = noise_covar_noCC,
                                                              dist = dist_obs_covar_noCC,
                                                              nest = nest_obs_covar_noCC,
                                                              site = site_obs_covar_noCC,
                                                              time = time_noCC), 
                                  siteCovs = site_covars_noCC) 
  
  

```

##
#### Run and compare models (constant psi)

##### - All detections
```{r echo=FALSE}
  #no time component  
    p1_any <- occu(~1                                          ~1, data = input_any)
    p2_any <- occu(~scale(dist)                                ~1, data = input_any)
    p3_any <- occu(~scale(dist) + scale(noise)                 ~1, data = input_any)
    p4_any <- occu(~scale(dist) +                site          ~1, data = input_any)
    p5_any <- occu(~scale(dist) + scale(noise) + site          ~1, data = input_any)
    p6_any <- occu(~scale(dist) +                nest          ~1, data = input_any)
    p7_any <- occu(~scale(dist) + scale(noise) + nest          ~1, data = input_any)
    p8_any <- occu(~scale(dist) +                scale(effort) ~1, data = input_any)
    p9_any <- occu(~scale(dist) + scale(noise) + scale(effort) ~1, data = input_any)
    p10_any <- occu(~scale(dist) + site +        scale(effort) ~1, data = input_any) #top model
    p11_any <- occu(~scale(dist) +        nest + scale(effort) ~1, data = input_any)
    p12_any <- occu(~scale(dist) + scale(noise) + site + scale(effort) ~1, data = input_any) 
    p13_any <- occu(~scale(dist) + scale(noise) + nest + scale(effort) ~1, data = input_any)
    
  #'p' with factor for week
    p2_any_time <- occu(~time + scale(dist)                                ~1, data = input_any)
    p3_any_time <- occu(~time + scale(dist) + scale(noise)                 ~1, data = input_any)
    p4_any_time <- occu(~time + scale(dist) +                site          ~1, data = input_any)
    p5_any_time <- occu(~time + scale(dist) + scale(noise) + site          ~1, data = input_any) #top
    p6_any_time <- occu(~time + scale(dist) +                nest          ~1, data = input_any)
    p7_any_time <- occu(~time + scale(dist) + scale(noise) + nest          ~1, data = input_any)
    p8_any_time <- occu(~time + scale(dist) +                scale(effort) ~1, data = input_any) #e
    p9_any_time <- occu(~time + scale(dist) + scale(noise) + scale(effort) ~1, data = input_any) #e
    p10_any_time <- occu(~time + scale(dist) + site +        scale(effort) ~1, data = input_any) #e
    p11_any_time <- occu(~time + scale(dist) +        nest + scale(effort) ~1, data = input_any) #e
    p12_any_time <- occu(~time + scale(dist) + scale(noise) + site+scale(effort)~1,data=input_any) #e
    p13_any_time <- occu(~time + scale(dist) + scale(noise) + nest+scale(effort)~1,data=input_any) #e
    
    modList_any_time <- fitList('p(.), psi(.)}' = p1_any,
              ) 
    modSel(modList_any_time)
    
  #compare models
        modList_any <- fitList('p(.), psi(.)}' = p1_any,
                   'p(dist), psi(.)' = p2_any,
                   'p(dist + noise), psi(.)' = p3_any, 
                   'p(dist + site), psi(.)' = p4_any,
                   'p(dist + noise + site), psi(.)' = p5_any, 
                   'p(dist + nest), psi(.)' = p6_any,
                   'p(dist + noise + nest), psi(.)' = p7_any,
                   'p(dist + effort), psi(.)' = p8_any,
                   'p(dist + noise + effort), psi(.)' = p9_any,
                   'p(dist + site + effort), psi(.)' = p10_any, 
                   'p(dist + nest + effort), psi(.)' = p11_any,
                   'p(dist + noise + site + effort), psi(.)' = p12_any, #top model
                   'p(dist + noise + nest + effort), psi(.)' = p13_any,
                   'p(time + dist), psi(.)' = p2_any_time,
                   'p(time + dist + noise), psi(.)' = p3_any_time, 
                   'p(time + dist + site), psi(.)' = p4_any_time,
                   'p(time + dist + noise + site), psi(.)' = p5_any_time, #top model w/ time (-20 AIC)
                   'p(time + dist + nest), psi(.)' = p6_any_time,
                   'p(time + dist + noise + nest), psi(.)' = p7_any_time) 
      modSel(modList_any)
    
```

##
##### - Female detections (FNLC or pair)
```{r echo=FALSE}
  #no time component
    p1_fem <- occu(~1                                          ~1, data = input_female)
    p2_fem <- occu(~scale(dist)                                ~1, data = input_female)
    p3_fem <- occu(~scale(dist) + scale(noise)                 ~1, data = input_female)
    p4_fem <- occu(~scale(dist) +                site          ~1, data = input_female)
    p5_fem <- occu(~scale(dist) + scale(noise) + site          ~1, data = input_female)
    p6_fem <- occu(~scale(dist) +                nest          ~1, data = input_female)
    p7_fem <- occu(~scale(dist) + scale(noise) + nest          ~1, data = input_female)
    p8_fem <- occu(~scale(dist) +                scale(effort) ~1, data = input_female)
    p9_fem <- occu(~scale(dist) + scale(noise) + scale(effort) ~1, data = input_female)
    p10_fem <- occu(~scale(dist) + site +   scale(effort) ~1, data = input_female) 
    p11_fem <- occu(~scale(dist) +        nest + scale(effort) ~1, data = input_female)
    p12_fem <- occu(~scale(dist) + scale(noise) + site + scale(effort) ~1,data=input_female)#top model
    p13_fem <- occu(~scale(dist) + scale(noise) + nest + scale(effort) ~1, data = input_female)
    
  #'p' with factor for week
    p2_fem_time <- occu(~time + scale(dist)                                ~1, data=input_female) #NAs
    p3_fem_time <- occu(~time + scale(dist) + scale(noise)                 ~1, data=input_female) #NAs
    p4_fem_time <- occu(~time + scale(dist) +                site          ~1, data=input_female)
    p5_fem_time <- occu(~time + scale(dist) + scale(noise) + site          ~1, data=input_female)
    p6_fem_time <- occu(~time + scale(dist) +                nest          ~1, data=input_female)
    p7_fem_time <- occu(~time + scale(dist) + scale(noise) + nest          ~1, data=input_female)
    p8_fem_time <- occu(~time + scale(dist) +                scale(effort) ~1, data=input_female) #e
    p9_fem_time <- occu(~time + scale(dist) + scale(noise) + scale(effort) ~1, data=input_female) #e
    p10_fem_time <- occu(~time + scale(dist) + site +   scale(effort) ~1,data=input_female) #e
    p11_fem_time <- occu(~time + scale(dist) +        nest + scale(effort) ~1, data = input_female) #e
    p12_fem_time <- occu(~time + scale(dist) + scale(noise)+site+scale(effort)~1,data=input_female) #e
    p13_fem_time <- occu(~time + scale(dist) + scale(noise)+nest+scale(effort)~1,data=input_female) #e
    
    modList_fem <- fitList('p(.), psi(.)}' = p1_fem,
                       'p(dist), psi(.)' = p2_fem,
                       'p(dist + noise), psi(.)' = p3_fem, 
                       'p(dist + site), psi(.)' = p4_fem,
                       'p(dist + noise + site), psi(.)' = p5_fem,
                       'p(dist + nest), psi(.)' = p6_fem,
                       'p(dist + noise + nest), psi(.)' = p7_fem,
                       'p(dist + effort), psi(.)' = p8_fem,
                       'p(dist + noise + effort), psi(.)' = p9_fem,
                       'p(dist + site + effort), psi(.)' = p10_fem, 
                       'p(dist + nest + effort), psi(.)' = p11_fem,
                       'p(dist + noise + site + effort), psi(.)' = p12_fem,#top model w/o time(-6 AIC)
                       'p(dist + noise + nest + effort), psi(.)' = p13_fem,
                       'p(time + dist), psi(.)' = p2_fem_time, #NAs
                       'p(time + dist + noise), psi(.)' = p3_fem_time, #NAs
                       'p(time + dist + site), psi(.)' = p4_fem_time,
                       'p(time + dist + noise + site), psi(.)' = p5_fem_time, #top model
                       'p(time + dist + nest), psi(.)' = p6_fem_time,
                       'p(time + dist + noise + nest), psi(.)' = p7_fem_time) 
    modSel(modList_fem)

```

## 
##### - Male detections (FNLC or pair)
```{r echo=FALSE}
  #no time component  
    p1_mal <- occu(~1                                          ~1, data = input_male)
    p2_mal <- occu(~scale(dist)                                ~1, data = input_male)
    p3_mal <- occu(~scale(dist) + scale(noise)                 ~1, data = input_male)
    p4_mal <- occu(~scale(dist) +                site          ~1, data = input_male)
    p5_mal <- occu(~scale(dist) + scale(noise) + site          ~1, data = input_male)
    p6_mal <- occu(~scale(dist) +                nest          ~1, data = input_male)
    p7_mal <- occu(~scale(dist) + scale(noise) + nest          ~1, data = input_male)
    p8_mal <- occu(~scale(dist) +                scale(effort) ~1, data = input_male)
    p9_mal <- occu(~scale(dist) + scale(noise) + scale(effort) ~1, data = input_male)
    p10_mal <- occu(~scale(dist) + site +   scale(effort) ~1, data = input_male) #top model
    p11_mal <- occu(~scale(dist) +        nest + scale(effort) ~1, data = input_male)
    p12_mal <- occu(~scale(dist) + scale(noise) + site + scale(effort) ~1, data=input_male)
    p13_mal <- occu(~scale(dist) + scale(noise) + nest + scale(effort) ~1, data=input_male)
    
  #'p' with factor for week
    p2_mal_time <- occu(~time + scale(dist)                                ~1, data = input_male)
    p3_mal_time <- occu(~time + scale(dist) + scale(noise)                 ~1, data = input_male)
    p4_mal_time <- occu(~time + scale(dist) +                site          ~1, data = input_male)
    p5_mal_time <- occu(~time + scale(dist) + scale(noise) + site          ~1, data = input_male)
    p6_mal_time <- occu(~time + scale(dist) +                nest          ~1, data = input_male)
    p7_mal_time <- occu(~time + scale(dist) + scale(noise) + nest          ~1, data = input_male) #e 
    p8_mal_time <- occu(~time + scale(dist) +                scale(effort) ~1, data = input_male) #e
    p9_mal_time <- occu(~time + scale(dist) + scale(noise) + scale(effort) ~1, data = input_male) #e
    p10_mal_time <- occu(~time + scale(dist) + site +   scale(effort) ~1,data=input_male) #e
    p11_mal_time <- occu(~time + scale(dist) +        nest + scale(effort)~1,data=input_male) #e
    p12_mal_time <- occu(~time + scale(dist) + scale(noise)+site+scale(effort)~1,data=input_male) #e
    p13_mal_time <- occu(~time + scale(dist) + scale(noise)+nest+scale(effort)~1, data=input_male) #e
    
    modList_mal_fnlcp <- fitList('p(.), psi(.)}' = p1_mal,
                       'p(dist), psi(.)' = p2_mal,
                       'p(dist + noise), psi(.)' = p3_mal, 
                       'p(dist + site), psi(.)' = p4_mal,
                       'p(dist + noise + site), psi(.)' = p5_mal, 
                       'p(dist + nest), psi(.)' = p6_mal,
                       'p(dist + noise + nest), psi(.)' = p7_mal,
                       'p(dist + effort), psi(.)' = p8_mal,
                       'p(dist + noise + effort), psi(.)' = p9_mal,
                       'p(dist + site + effort), psi(.)' = p10_mal, #only -8 AIC
                       'p(dist + nest + effort), psi(.)' = p11_mal,
                       'p(dist + noise + site + effort), psi(.)' = p12_mal, #top model
                       'p(dist + noise + nest + effort), psi(.)' = p13_mal,
                       'p(time + dist), psi(.)' = p2_mal_time, 
                       'p(time + dist + noise), psi(.)' = p3_mal_time, 
                       'p(time + dist + site), psi(.)' = p4_mal_time,
                       'p(time + dist + noise + site), psi(.)' = p5_mal_time, #top model w/time (-26)
                       'p(time + dist + nest), psi(.)' = p6_mal_time,
                       'p(time + dist + noise + nest), psi(.)' = p7_mal_time) 
    modSel(modList_mal_fnlcp)    
    
```

## 
#### View parameter estimate from top models above
```{r echo=FALSE}

    p12_any
    p12_fem
    p12_mal

```

##
#### Create marginal plots (by site): p(dist + noise + site + effort)
```{r echo=FALSE}

  ## Format covariate values to predict on
    dist_grid   <- sort(c(mean(site_covars$dist_actual), 
                          seq(min(site_covars$dist_actual), max(site_covars$dist_actual), 
                              length = 50)))
    effort_grid <- sort(c(effort_mean, seq(min(effort_covar), max(effort_covar), length = 49)))
    noise_grid  <- sort(c(noise_mean, seq(min(noise_covar), max(noise_covar), length = 49)))
    site_grid   <- unique(site_covars$site_name) 
    
      covars12 <- expand.grid('dist' = dist_grid, 'effort' = effort_grid,
                              'noise' = noise_grid, 'site' = site_grid)
      
    # And change site-level names for plotting
      site_covars$site <- site_covars$site_name
      site_covars$nest <- site_covars$nested

    
  ## Predict (slow) -- remember to source R script above for this function
    preds12any <- occPred(p12_any, covars12, 'any')
    preds12fem <- occPred(p12_fem, covars12, 'female')
    preds12mal <- occPred(p12_mal, covars12, 'male')

    predsAll <- do.call('rbind', list(preds12any, preds12fem, preds12mal))

   
  ## Plot    
     
    #(y ~ dist + site)
    plot12dist <- ggplot(predsAll[predsAll$effort == effort_mean
                                         & predsAll$noise == noise_mean
                                         & predsAll$variable %in% 'det',],
                            aes(x = dist/1000, y = value, color = group, fill = group)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3, color = NA) + #color=NA to remove outlines
      ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Distance (km)') +
      ggtitle('p(distance + noise + effort + site) psi(.)') +
      geom_rug(data = site_covars, aes(x = dist_actual/1000), inherit.aes = FALSE) +
      facet_grid(~ site) + theme_bw()

    plot12dist
    
    #(y ~ effort + site)
    plot12effort <- ggplot(predsAll[predsAll$dist == mean(site_covars$dist_actual) 
                                               & predsAll$noise == noise_mean
                                               & predsAll$variable %in% 'det',], 
                         aes(x = effort, y = value, color = group, fill = group)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3, color = NA) +
      ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Effort') +
      ggtitle('All detections: p(distance + noise + effort + site) psi(.)') +
      geom_rug(data = effort_df, aes(x = effort), inherit.aes = FALSE) +
      facet_grid(~ site) + theme_bw()
    plot12effort
    
    #(y ~ noise + site)
    plot12noise <- ggplot(predsAll[predsAll$dist == mean(site_covars$dist_actual)
                                   & predsAll$effort == effort_mean
                                   & predsAll$variable %in% 'det',], 
                         aes(x = noise, y = value, color = group, fill = group)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3, color = NA) +
      ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Noise') +
      ggtitle('All detections: p(distance + noise + effort + site) psi(.)') +
      geom_rug(data = noise_df, aes(x = noise), inherit.aes = FALSE) +
      facet_grid(~ site) + theme_bw()
    plot12noise
    
```
## 
## 
Ok, there is really just one outlier at Miller Creek (MC) with very large effort. 
Should truncate that or replace with mean.
There shouldn't be *this* strong of a relationship with effort (it was pretty constant)

##
#### Create marginal plots (grouped): p(dist)
```{r echo=FALSE}

  # p2_any@call
  # head(new_covar)

  #format distance covar
  dist_covar <- data.frame('dist' = new_covar$dist)
  
    #predict
    det_pred_2any <- predict(p2_any, type = 'det', dist_covar)
    det_pred_2fem <- predict(p2_fem_fnlcp, type = 'det', dist_covar)
    det_pred_2mal <- predict(p2_mal_fnlcp, type = 'det', dist_covar)
    
    occ_pred_2any <- predict(p2_any, type = 'state', dist_covar)
    occ_pred_2fem <- predict(p2_fem_fnlcp, type = 'state', dist_covar)
    occ_pred_2mal <- predict(p2_mal_fnlcp, type = 'state', dist_covar)
    
    #Combine covariates with predictions
    pred_wide_any <- cbind(dist_covar, 'det' = det_pred_2any$Predicted, 'occ' = occ_pred_2any$Predicted)
    lci_wide_any  <- cbind(dist_covar, 'det' = det_pred_2any$lower, 'occ' = det_pred_2any$lower)
    uci_wide_any  <- cbind(dist_covar, 'det' = det_pred_2any$upper, 'occ' = det_pred_2any$upper)
    
    pred_long_any <- melt(pred_wide_any, id.vars = c('dist'), value.name = 'value')
    lci_long_any  <- melt(lci_wide_any, id.vars = c('dist'), value.name = 'LCI')
    uci_long_any  <- melt(uci_wide_any, id.vars = c('dist'), value.name = 'UCI')
    
      plot_data_any <- cbind(pred_long_any, 'LCI' = lci_long_any$LCI, 'UCI' = uci_long_any$UCI)
    
    pred_wide_fem <- cbind(dist_covar, 'det' = det_pred_2fem$Predicted, 'occ' = occ_pred_2fem$Predicted)
    lci_wide_fem  <- cbind(dist_covar, 'det' = det_pred_2fem$lower, 'occ' = det_pred_2fem$lower)
    uci_wide_fem  <- cbind(dist_covar, 'det' = det_pred_2fem$upper, 'occ' = det_pred_2fem$upper)
    
    pred_long_fem <- melt(pred_wide_fem, id.vars = c('dist'), value.name = 'value')
    lci_long_fem  <- melt(lci_wide_fem, id.vars = c('dist'), value.name = 'LCI')
    uci_long_fem  <- melt(uci_wide_fem, id.vars = c('dist'), value.name = 'UCI')
      
      plot_data_fem <- cbind(pred_long_fem, 'LCI' = lci_long_fem$LCI, 'UCI' = uci_long_fem$UCI)
  
    pred_wide_mal <- cbind(dist_covar, 'det' = det_pred_2mal$Predicted, 'occ' = occ_pred_2mal$Predicted)
    lci_wide_mal  <- cbind(dist_covar, 'det' = det_pred_2mal$lower, 'occ' = det_pred_2mal$lower)
    uci_wide_mal  <- cbind(dist_covar, 'det' = det_pred_2mal$upper, 'occ' = det_pred_2mal$upper)
    
    pred_long_mal <- melt(pred_wide_mal, id.vars = c('dist'), value.name = 'value')
    lci_long_mal  <- melt(lci_wide_mal, id.vars = c('dist'), value.name = 'LCI')
    uci_long_mal  <- melt(uci_wide_mal, id.vars = c('dist'), value.name = 'UCI')
      
      plot_data_mal <- cbind(pred_long_mal, 'LCI' = lci_long_mal$LCI, 'UCI' = uci_long_mal$UCI)

      
    #Plot    
    plot_data_any$group <- 'Any'; plot_data_fem$group <- 'Female'; plot_data_mal$group <- 'Male'
    plot_combine <- do.call('rbind', list(plot_data_any, plot_data_fem, plot_data_mal))
    
    #All together
    plot_p2_dist <- ggplot(plot_combine[plot_combine$variable %in% 'det',], 
                           aes(x = dist/1000, y = value, color = group, fill = group)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3, color = NA) + #color=NA to remove outlines
      ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Distance (km)') +
      ggtitle('p(distance) psi(.)') +
      geom_rug(data = site_covars, aes(x = dist_actual/1000), inherit.aes = FALSE) +
      # facet_grid(~ site) + 
      theme_bw()
    plot_p2_dist
    
      
```

##
#### Create marginal plots (by nest status): p(dist + nest)
```{r echo=FALSE}

  # p4_any@call
  # head(new_covar)
  
  #create 'nest' covar
  nest_grid <- unique(site_covars$nested)
  nest_covar <- expand.grid('dist' = dist_grid, 'nest' = nest_grid)
  
    #predict
    det_pred_4any <- predict(p4_any, type = 'det', nest_covar)
    det_pred_4fem <- predict(p4_fem_fnlcp, type = 'det', nest_covar)
    det_pred_4mal <- predict(p4_mal_fnlcp, type = 'det', nest_covar)
    
    occ_pred_4any <- predict(p4_any, type = 'state', nest_covar)
    occ_pred_4fem <- predict(p4_fem_fnlcp, type = 'state', nest_covar)
    occ_pred_4mal <- predict(p4_mal_fnlcp, type = 'state', nest_covar)

    #Combine covariates with predictions
    pred_wide_any <- cbind(nest_covar, 'det' = det_pred_4any$Predicted, 'occ' = occ_pred_4any$Predicted)
    lci_wide_any  <- cbind(nest_covar, 'det' = det_pred_4any$lower, 'occ' = det_pred_4any$lower)
    uci_wide_any  <- cbind(nest_covar, 'det' = det_pred_4any$upper, 'occ' = det_pred_4any$upper)
    
    pred_long_any <- melt(pred_wide_any, id.vars = c('nest','dist'), value.name = 'value')
    lci_long_any  <- melt(lci_wide_any, id.vars = c('nest','dist'), value.name = 'LCI')
    uci_long_any  <- melt(uci_wide_any, id.vars = c('nest','dist'), value.name = 'UCI')
    
      plot_data_any <- cbind(pred_long_any, 'LCI' = lci_long_any$LCI, 'UCI' = uci_long_any$UCI)
    
    pred_wide_fem <- cbind(nest_covar, 'det' = det_pred_4fem$Predicted, 'occ' = occ_pred_4fem$Predicted)
    lci_wide_fem  <- cbind(nest_covar, 'det' = det_pred_4fem$lower, 'occ' = det_pred_4fem$lower)
    uci_wide_fem  <- cbind(nest_covar, 'det' = det_pred_4fem$upper, 'occ' = det_pred_4fem$upper)
    
    pred_long_fem <- melt(pred_wide_fem, id.vars = c('nest','dist'), value.name = 'value')
    lci_long_fem  <- melt(lci_wide_fem, id.vars = c('nest','dist'), value.name = 'LCI')
    uci_long_fem  <- melt(uci_wide_fem, id.vars = c('nest','dist'), value.name = 'UCI')
    
      plot_data_fem <- cbind(pred_long_fem, 'LCI' = lci_long_fem$LCI, 'UCI' = uci_long_fem$UCI)
    
    pred_wide_mal <- cbind(nest_covar, 'det' = det_pred_4mal$Predicted, 'occ' = occ_pred_4mal$Predicted)
    lci_wide_mal  <- cbind(nest_covar, 'det' = det_pred_4mal$lower, 'occ' = det_pred_4mal$lower)
    uci_wide_mal  <- cbind(nest_covar, 'det' = det_pred_4mal$upper, 'occ' = det_pred_4mal$upper)
    
    pred_long_mal <- melt(pred_wide_mal, id.vars = c('nest','dist'), value.name = 'value')
    lci_long_mal  <- melt(lci_wide_mal, id.vars = c('nest','dist'), value.name = 'LCI')
    uci_long_mal  <- melt(uci_wide_mal, id.vars = c('nest','dist'), value.name = 'UCI')
    
      plot_data_mal <- cbind(pred_long_mal, 'LCI' = lci_long_mal$LCI, 'UCI' = uci_long_mal$UCI)
  
      
    #Plot    
    plot_data_any$group <- 'Any'; plot_data_fem$group <- 'Female'; plot_data_mal$group <- 'Male'
    plot_combine <- do.call('rbind', list(plot_data_any, plot_data_fem, plot_data_mal))
    
    site_covars$nest <- site_covars$nested
    
    #All together
    plot_p4_dist <- ggplot(plot_combine[plot_combine$variable %in% 'det',], 
                           aes(x = dist/1000, y = value, color = group, fill = group)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3, color = NA) + #color=NA to remove outlines
      ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Distance (km)') +
      ggtitle('p(distance + nest) psi(.)') +
      geom_rug(data = site_covars, aes(x = dist_actual/1000), inherit.aes = FALSE) +
      facet_grid(~ nest) + theme_bw()
    plot_p4_dist
    

    plot_p4_dist2 <- ggplot(plot_combine[plot_combine$variable %in% 'det',], 
                           aes(x = dist/1000, y = value, color = nest, fill = nest)) +
      geom_line() +
      geom_ribbon(aes(ymin = LCI, ymax = UCI), alpha = 0.3, color = NA) + #color=NA to remove outlines
      ylim(0,1) +
      ylab('Weekly detection probability (\u00B1 95 CI)') +
      xlab('Distance (km)') +
      ggtitle('p(distance + nest) psi(.)') +
      geom_rug(data = site_covars, aes(x = dist_actual/1000), inherit.aes = FALSE) +
      facet_grid(~ group) + theme_bw()
    plot_p4_dist2
      
```

## 
### Try models with time-varying 'p'

```{r echo=FALSE, warning=FALSE}

  #ANY detections (constant psi) - time-varying p
    p1_any_time <- occu(~1                                  ~1, data = input_any)
    p2_any_time <- occu(~dist                        + time ~1, data = input_any)
    p3_any_time <- occu(~dist + site                 + time ~1, data = input_any) #top model
    p4_any_time <- occu(~dist +        nest          + time ~1, data = input_any)
    p5_any_time <- occu(~dist +               effort + time ~1, data = input_any) 
    p6_any_time <- occu(~                     effort + time ~1, data = input_any) 
    p7_any_time <- occu(~dist + site +        effort + time ~1, data = input_any) 
    p8_any_time <- occu(~dist +        nest + effort + time ~1, data = input_any)
    p9_any_time <- occu(~                              time ~1, data = input_any)
    
    modList_any_time <- fitList('p(.), psi(.)}' = p1_any_time,
                           'p(dist + time), psi(.)' = p2_any_time,
                           'p(dist + site + time), psi(.)' = p3_any_time, #top model
                           'p(dist + nest + time), psi(.)' = p4_any_time,
                           'p(dist + effort + time), psi(.)' = p5_any_time,
                           'p(effort) + time, psi(.)' = p6_any_time,
                           'p(dist + site + effort + time), psi(.)' = p7_any_time,
                           'p(dist + nest + effort + time), psi(.)' = p8_any_time,
                           'p(time), psi(.)' = p9_any_time) 
    modSel(modList_any_time)
    
    
  #FEMALE FNLCP detections (constant psi) - time-varying p
    p1_fem_fnlcp_time <- occu(~1                                  ~1, data = input_female_fnlcp)
    p2_fem_fnlcp_time <- occu(~dist                        + time ~1, data = input_female_fnlcp)
    p3_fem_fnlcp_time <- occu(~dist + site                 + time ~1, data = input_female_fnlcp) #top model
    p4_fem_fnlcp_time <- occu(~dist +        nest          + time ~1, data = input_female_fnlcp) 
    p5_fem_fnlcp_time <- occu(~dist +               effort + time ~1, data = input_female_fnlcp) #error (NAs in SE)
    p6_fem_fnlcp_time <- occu(~                     effort + time ~1, data = input_female_fnlcp)
    p7_fem_fnlcp_time <- occu(~dist + site +        effort + time ~1, data = input_female_fnlcp) #error (NAs in SE)
    p8_fem_fnlcp_time <- occu(~dist +        nest + effort + time ~1, data = input_female_fnlcp) #error (NAs in SE)
    p9_fem_fnlcp_time <- occu(~                              time ~1, data = input_female_fnlcp)
    
    modList_femFNLCP_time <- fitList('p(.), psi(.)}' = p1_fem_fnlcp_time,
                                'p(dist + time), psi(.)' = p2_fem_fnlcp_time,
                                'p(dist + site + time), psi(.)' = p3_fem_fnlcp_time, #top model
                                'p(dist + nest + time), psi(.)' = p4_fem_fnlcp_time,
                                'p(dist + effort + time), psi(.)' = p5_fem_fnlcp_time,
                                'p(effort) + time, psi(.)' = p6_fem_fnlcp_time,
                                'p(dist + site + effort + time), psi(.)' = p7_fem_fnlcp_time,
                                'p(dist + nest + effort + time), psi(.)' = p8_fem_fnlcp_time,
                                'p(time), psi(.)' = p9_fem_fnlcp_time) 
    # modSel(modList_femFNLCP_time)
    
    
  #MALE FNLC detections (constant psi) - time-varying p
    p1_mal_fnlcp_time <- occu(~1                                  ~1, data = input_male_fnlcp)
    p2_mal_fnlcp_time <- occu(~dist                        + time ~1, data = input_male_fnlcp)
    p3_mal_fnlcp_time <- occu(~dist + site                 + time ~1, data = input_male_fnlcp) #top model
    p4_mal_fnlcp_time <- occu(~dist +        nest          + time ~1, data = input_male_fnlcp) 
    p5_mal_fnlcp_time <- occu(~dist +               effort + time ~1, data = input_male_fnlcp) 
    p6_mal_fnlcp_time <- occu(~                     effort + time ~1, data = input_male_fnlcp) 
    p7_mal_fnlcp_time <- occu(~dist + site +        effort + time ~1, data = input_male_fnlcp) #error (NAs in SE)
    p8_mal_fnlcp_time <- occu(~dist +        nest + effort + time ~1, data = input_male_fnlcp) 
    p9_mal_fnlcp_time <- occu(~                              time ~1, data = input_male_fnlcp)
    
    modList_malFNLCP_time <- fitList('p(.), psi(.)}' = p1_mal_fnlcp_time,
                                     'p(dist + time), psi(.)' = p2_mal_fnlcp_time,
                                     'p(dist + site + time), psi(.)' = p3_mal_fnlcp_time, #top model
                                     'p(dist + nest + time), psi(.)' = p4_mal_fnlcp_time,
                                     'p(dist + effort + time), psi(.)' = p5_mal_fnlcp_time,
                                     'p(effort) + time, psi(.)' = p6_mal_fnlcp_time,
                                     'p(dist + site + effort + time), psi(.)' = p7_mal_fnlcp_time,
                                     'p(dist + nest + effort + time), psi(.)' = p8_mal_fnlcp_time,
                                     'p(time), psi(.)' = p9_mal_fnlcp_time) 
    # modSel(modList_malFNLCP_time) 
    
    
  #Examine results -- do this without site/nest first for simplicity [p(DIST + NEST + TIME) psi(.)]
    p2_any_time
    # p2_fem_fnlcp_time
    # p2_mal_fnlcp_time
    
  #Format covariates
    new_covar_time <- expand.grid('dist' = dist_grid, 'time' = as.character(unique(time)),
                                  'nest' = nest_grid)
    
  #Predict
    det_pred_p2any_time <- predict(p2_any_time, type = 'det', new_covar_time[,-3])
    det_pred_p2any_time_df <- cbind(new_covar_time, det_pred_p2any_time)

    det_pred_p2fem_time <- predict(p2_fem_fnlcp_time, type = 'det', new_covar_time[,-3])
    det_pred_p2fem_time_df <- cbind(new_covar_time, det_pred_p2fem_time)
    
    det_pred_p2mal_time <- predict(p2_mal_fnlcp_time, type = 'det', new_covar_time[,-3])
    det_pred_p2mal_time_df <- cbind(new_covar_time, det_pred_p2mal_time)
    
    p_by_week_any <- det_pred_p2any_time_df %>% group_by(time) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
    p_by_week_fem <- det_pred_p2fem_time_df %>% group_by(time) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
    p_by_week_mal <- det_pred_p2mal_time_df %>% group_by(time) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
```
   
##
#### Create marginal plots (grouped): p(dist + time)
  
```{r, echo = FALSE}    

  #Any
    plot_p2_dist_time_any <- ggplot(p_by_week_any, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2any_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci)) +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Any STOC): p(dist + time)') +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p2_dist_time_any
    
    # ggplot(det_pred_p2any_time_df, aes(x = time, y = Predicted)) +
    #   geom_boxplot(outlier.colour = 'black', outlier.shape = 16,
    #                outlier.size = 2, notch = TRUE) +
    #   ylim(0,1) +
    #   xlab('Week') + ylab('Detection probability') +
    #   ggtitle('Detection probability (Any STOC)') +
    #   theme_bw()
    
  #Female
    plot_p2_dist_time_fem <- ggplot(p_by_week_fem, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2fem_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci), color = 'tomato') +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Female STOC): p(dist + time)') +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p2_dist_time_fem
    
    # ggplot(det_pred_p2fem_time_df, aes(x = time, y = Predicted)) +
    #   geom_boxplot(outlier.colour = 'black', outlier.shape = 16,
    #                outlier.size = 2, notch = TRUE) +
    #   ylim(0,1) +
    #   xlab('Week') + ylab('Detection probability') +
    #   ggtitle('Detection probability (Female STOC)') +
    #   theme_bw()

  #Male
    plot_p2_dist_time_mal <- ggplot(p_by_week_mal, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2mal_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
                 # position = position_jitter(width = 0.1)) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci), color = 'cyan3') +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Male STOC): p(dist + time)') +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p2_dist_time_mal
    
    # ggplot(det_pred_p2mal_time_df, aes(x = time, y = Predicted)) +
    #   geom_boxplot(outlier.colour = 'black', outlier.shape = 16,
    #                outlier.size = 2, notch = TRUE) +
    #   ylim(0,1) +
    #   xlab('Week') + ylab('Detection probability') +
    #   ggtitle('Detection probability (Male STOC)') +
    #   theme_bw()

```

## 
#### Create marginal plots (by nest status): p(dist + nest + time)
```{r, echo = FALSE}
    
  #Examine results
  # p4_any_time
  # p4_fem_fnlcp_time
  # p4_mal_fnlcp_time
  
  #Predict
    det_pred_p4any_time <- predict(p4_any_time, type = 'det', new_covar_time)
    det_pred_p4any_time_df <- cbind(new_covar_time, det_pred_p4any_time)
    
    det_pred_p4fem_time <- predict(p4_fem_fnlcp_time, type = 'det', new_covar_time)
    det_pred_p4fem_time_df <- cbind(new_covar_time, det_pred_p4fem_time)
    
    det_pred_p4mal_time <- predict(p4_mal_fnlcp_time, type = 'det', new_covar_time)
    det_pred_p4mal_time_df <- cbind(new_covar_time, det_pred_p4mal_time)
    
    p_by_week_any <- det_pred_p4any_time_df %>% group_by(time, nest) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
    p_by_week_fem <- det_pred_p4fem_time_df %>% group_by(time, nest) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
    p_by_week_mal <- det_pred_p4mal_time_df %>% group_by(time, nest) %>%
      summarise(p_weekly_mean = mean(Predicted),
                p_weekly_lci  = mean(lower),
                p_weekly_uci  = mean(upper),
                .groups = 'drop')
    
  ## Plot
    
  #Any
    plot_p4_dist_time_any <- ggplot(p_by_week_any, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2any_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci)) +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Any STOC): p(dist + nest + time)') +
      facet_grid(~nest) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p4_dist_time_any

  #Female
    plot_p4_dist_time_fem <- ggplot(p_by_week_fem, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2fem_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci), color = 'tomato') +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Female STOC): p(dist + nest + time)') +
      facet_grid(~nest) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p4_dist_time_fem
    
  #Male
    plot_p4_dist_time_mal <- ggplot(p_by_week_mal, aes(x = time, y = p_weekly_mean)) +
      geom_point(data = det_pred_p2mal_time_df, aes(x = time, y = Predicted), 
                 color = 'lightgray', size = 0.5) +
      # position = position_jitter(width = 0.1)) +
      geom_pointrange(aes(ymin = p_weekly_lci, ymax = p_weekly_uci), color = 'cyan3') +
      ylim(0,1) +
      xlab('Week') + ylab('Detection probability') +
      ggtitle('Detection probability (Male STOC): p(dist + nest + time)') +
      facet_grid(~nest) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
    plot_p4_dist_time_mal

    
```

